# è§†é¢‘è¯„è®ºç½®é¡¶æµç¨‹è®¾è®¡æ–‡æ¡£

> åŸºäº easylive-java é¡¹ç›®éœ€æ±‚ï¼ŒæŒ‰ç…§ DDD äº‹ä»¶é©±åŠ¨æ¨¡å¼è®¾è®¡

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ¦‚è¿°
è§†é¢‘ä½œè€…ï¼ˆæˆ–ç®¡ç†å‘˜ï¼‰å¯¹æŸæ¡è¯„è®ºè¿›è¡Œç½®é¡¶æ“ä½œï¼Œä½¿å…¶åœ¨è¯„è®ºåˆ—è¡¨ä¸­ä¼˜å…ˆå±•ç¤ºã€‚ç³»ç»Ÿéœ€æ ¡éªŒè¯„è®ºå­˜åœ¨æ€§ã€ç¡®è®¤è¯„è®ºå±äºç›®æ ‡è§†é¢‘ï¼Œå¹¶éªŒè¯æ“ä½œè€…å¯¹è¯¥è§†é¢‘æ‹¥æœ‰ç®¡ç†æƒé™ã€‚è‹¥ç³»åˆ—ä¸­å·²æœ‰å…¶ä»–ç½®é¡¶è¯„è®ºï¼Œåº”å–æ¶ˆåŸç½®é¡¶åå†è®¾ç½®æ–°çš„ç½®é¡¶ã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ASCII æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ï¼šPOST /comment/topComment                            â”‚
â”‚ Payload: { "commentId": 345678 }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ§åˆ¶å™¨ï¼šCommentController#commentTop âœ…                   â”‚
â”‚ 1. è§£æç™»å½•ç”¨æˆ· â†’ operatorId                             â”‚
â”‚ 2. Mediator.commands.send(TopCommentCmd.Request)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šTopCommentCmd âœ…                                     â”‚
â”‚ 1. åŠ è½½è¯„è®º & è§†é¢‘ä¿¡æ¯                                    â”‚
â”‚ 2. æ ¡éªŒè¯„è®ºå½’å±/è§†é¢‘ä½œè€…æƒé™                              â”‚
â”‚ 3. è‹¥å­˜åœ¨å…¶ä»–ç½®é¡¶ â†’ commentRepository.untop(videoId) âœ…    â”‚
â”‚ 4. è°ƒç”¨ VideoComment.top()ï¼ˆèšåˆè¡Œä¸ºï¼‰                     â”‚
â”‚ 5. Mediator.uow.save()                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCommentToppedDomainEvent âœ…                     â”‚
â”‚ ç”±èšåˆåœ¨ onTop/onCreate ä¸­è‡ªåŠ¨å‘å¸ƒ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶ç›‘å¬å™¨ï¼šCommentToppedDomainEventSubscriber âšª         â”‚
â”‚ â†’ åç»­å‘½ä»¤ï¼šRefreshVideoCommentTopCmd âŒï¼ˆåˆ·æ–°ç¼“å­˜/æ¨é€ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯
1. **ä½œè€…ç½®é¡¶è‡ªå·±çš„è§†é¢‘è¯„è®º**ï¼šæ“ä½œæˆåŠŸï¼ŒåŸç½®é¡¶è¯„è®ºï¼ˆå¦‚æœ‰ï¼‰è¢«å–æ¶ˆï¼Œæ–°è¯„è®ºç½®é¡¶ã€‚
2. **è¶Šæƒç½®é¡¶**ï¼šæ“ä½œè€…ä¸æ˜¯è§†é¢‘ä½œè€…ï¼ŒæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆCODE_600ï¼‰ã€‚
3. **è¯„è®ºä¸å­˜åœ¨æˆ–å·²åˆ é™¤**ï¼šæŸ¥è¯¢è¿”å›ç©ºï¼ŒæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆCODE_600ï¼‰ã€‚

### Mermaid æµç¨‹å›¾
```mermaid
graph TD
    A[è¯·æ±‚: POST /comment/topComment<br/>commentId] --> B[æ§åˆ¶å™¨: CommentController âœ…<br/>Mediator.commands]
    B --> C[å‘½ä»¤: TopCommentCmd âœ…]
    C --> C1{è¯„è®ºå­˜åœ¨?}
    C1 -->|å¦| X[ä¸šåŠ¡å¼‚å¸¸: è¯„è®ºä¸å­˜åœ¨ âŒ]
    C1 -->|æ˜¯| C2[æ ¡éªŒè§†é¢‘å½’å± & æƒé™ âœ…]
    C2 --> C3{å·²æœ‰ç½®é¡¶è¯„è®º?}
    C3 -->|æ˜¯| C4[å–æ¶ˆæ—§ç½®é¡¶ âœ…]
    C3 -->|å¦| C5[è°ƒç”¨ comment.top() âœ…]
    C4 --> C5
    C5 --> D[ä¿å­˜äº‹åŠ¡ âœ…]
    D --> E[é¢†åŸŸäº‹ä»¶: CommentToppedDomainEvent âœ…]
    E --> F[äº‹ä»¶ç›‘å¬å™¨: CommentToppedDomainEventSubscriber âšª]
    F --> G[å‘½ä»¤: RefreshVideoCommentTopCmd âŒ<br/>åˆ·æ–°ç¼“å­˜/æ¨é€]
```

---

## ğŸ“¦ è®¾è®¡å…ƒç´ æ¸…å•

### âœ… å·²å­˜åœ¨çš„è®¾è®¡

- æ§åˆ¶å™¨ï¼š`CommentController#commentTop` ä½¿ç”¨ Mediator å‘é€å‘½ä»¤ï¼ˆ`only-danmuku-adapter/.../CommentController.kt:90`ï¼‰
- å‘½ä»¤ï¼š`TopCommentCmd`ã€`UntopCommentCmd`ï¼ˆ`only-danmuku-application/.../commands/video_comment`ï¼‰
- èšåˆè¡Œä¸ºï¼š`VideoComment.top()` / `VideoComment.untop()` è‡ªåŠ¨å‘å¸ƒå¯¹åº”é¢†åŸŸäº‹ä»¶
- äº‹ä»¶ç›‘å¬å™¨ï¼š`CommentToppedDomainEventSubscriber`ï¼ˆå·²ç”Ÿæˆï¼Œå¾…è¡¥å……ç¼“å­˜åˆ·æ–°é€»è¾‘ï¼‰
- éªŒè¯å™¨ï¼š`@VideoCommentOwner` æ ¡éªŒè¯„è®ºå½’å±ã€æ“ä½œè€…æƒé™ï¼ˆ
  `only-danmuku-application/src/main/kotlin/edu/only4/danmuku/application/validater/VideoCommentOwner.kt`ï¼‰

---

## âŒ ç¼ºå¤±çš„è®¾è®¡æ¸…å•

| ç±»å‹    | ç¼ºå¤±é¡¹                                     | æè¿°                   | å»ºè®®ä½ç½®                                           | ä¼˜å…ˆçº§ |
|-------|-----------------------------------------|----------------------|------------------------------------------------|-----|
| éªŒè¯å™¨   | `@CommentTopPermission`                 | æ ¡éªŒç½®é¡¶æ“ä½œè€…æ˜¯å¦ä¸ºè§†é¢‘ä½œè€…/ç®¡ç†å‘˜   | `only-danmuku-application/.../validater/`      | P0  |
| æŸ¥è¯¢    | `GetTopCommentByVideoQry`               | è·å–è§†é¢‘å½“å‰ç½®é¡¶è¯„è®ºï¼Œä¾›å‘½ä»¤å†…éƒ¨äº’æ–¥å¤„ç† | `design/aggregate/video_comment/_gen.json`     | P0  |
| å‘½ä»¤    | `RefreshVideoCommentTopCmd`             | ç½®é¡¶å˜æ›´ååŒæ­¥ç¼“å­˜/é€šçŸ¥         | `design/extra/comment_top_gen.json`            | P1  |
| äº‹ä»¶å¤„ç†å™¨ | `CommentToppedDomainEventSubscriber` å®ç° | è®¢é˜…äº‹ä»¶åè§¦å‘åˆ·æ–°å‘½ä»¤          | `only-danmuku-application/.../subscribers/...` | P1  |

---

## ğŸ”‘ å…³é”®ä¸šåŠ¡è§„åˆ™
- **æƒé™**ï¼šåªæœ‰è§†é¢‘ä½œè€…æˆ–å…·å¤‡ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ç½®é¡¶è¯„è®ºã€‚
- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªè§†é¢‘æœ€å¤šåªæœ‰ä¸€æ¡ç½®é¡¶è¯„è®ºï¼Œç½®é¡¶æ–°è¯„è®ºæ—¶éœ€å–æ¶ˆæ—§çš„ã€‚
- **çŠ¶æ€ç»´æŠ¤**ï¼š`VideoComment` ä¸­åº”é€šè¿‡æšä¸¾æˆ–å¸ƒå°”å­—æ®µè¡¨ç¤ºç½®é¡¶çŠ¶æ€ï¼›å–æ¶ˆç½®é¡¶æ—¶æ¢å¤ä¸ºæ™®é€šçŠ¶æ€ã€‚
- **å±•ç¤ºåŒæ­¥**ï¼šç½®é¡¶å˜æ›´ååº”åˆ·æ–°å®¢æˆ·ç«¯è¯„è®ºåˆ—è¡¨ç¼“å­˜ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ã€‚
- **å®¡è®¡**ï¼šå»ºè®®è®°å½•ç½®é¡¶æ“ä½œæ—¥å¿—ï¼ˆæ“ä½œè€…ã€ç›®æ ‡è¯„è®ºã€æ—¶é—´ï¼‰ã€‚

---

## ğŸ§¾ æ§åˆ¶å™¨ä¸å‘½ä»¤ç¤ºä¾‹
```kotlin
@PostMapping("/topComment")
fun commentTop(@RequestBody @Validated request: CommentTop.Request): CommentTop.Response {
    Mediator.commands.send(
        TopCommentCmd.Request(
            commentId = request.commentId.toLong()
        )
    )
    return CommentTop.Response()
}
```

> å‚è€ƒï¼š`only-danmuku-adapter/src/main/kotlin/edu/only4/danmuku/adapter/portal/api/CommentController.kt`

```kotlin
// å‘½ä»¤æ ¸å¿ƒé€»è¾‘ï¼ˆTopCommentCmd.Handlerï¼‰
val comment = Mediator.repositories.findFirst(
    SVideoComment.predicateById(request.commentId),
    persist = false
).getOrNull() ?: throw KnownException("è¯„è®ºä¸å­˜åœ¨ï¼š${request.commentId}")
// TODO: æ ¡éªŒæ“ä½œè€…æƒé™ã€å–æ¶ˆæ—§ç½®é¡¶
comment.top()
Mediator.uow.save()
```

---

## ğŸ“‚ ä¼ ç»Ÿæ¶æ„å‚è€ƒ
- æ§åˆ¶å™¨ï¼š`easylive-java/easylive-web/src/main/java/com/easylive/web/controller/VideoCommentController.java:227`
- ç›¸å…³æšä¸¾ï¼š`CommentTopTypeEnum`
- æœåŠ¡å®ç°ï¼ˆéœ€ç»“åˆ `VideoCommentServiceImpl` æŸ¥çœ‹å…·ä½“ç»†èŠ‚ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**è¿‘æœŸå˜æ›´**ï¼šç»Ÿä¸€ä¸ºâ€œè¯·æ±‚â†’å‘½ä»¤â†’äº‹ä»¶â†’å‘½ä»¤â€æµç¨‹ï¼Œè¡¥å……ç°æœ‰å‘½ä»¤/äº‹ä»¶ç›‘å¬å™¨ä¸ç¼ºå£è¯´æ˜ã€‚

