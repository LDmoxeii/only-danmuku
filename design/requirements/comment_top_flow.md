# è§†é¢‘è¯„è®ºç½®é¡¶æµç¨‹è®¾è®¡æ–‡æ¡£

> åŸºäº easylive-java é¡¹ç›®éœ€æ±‚ï¼ŒæŒ‰ç…§ DDD äº‹ä»¶é©±åŠ¨æ¨¡å¼è®¾è®¡

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ¦‚è¿°
è§†é¢‘ä½œè€…ï¼ˆæˆ–ç®¡ç†å‘˜ï¼‰å¯¹æŸæ¡è¯„è®ºè¿›è¡Œç½®é¡¶æ“ä½œï¼Œä½¿å…¶åœ¨è¯„è®ºåˆ—è¡¨ä¸­ä¼˜å…ˆå±•ç¤ºã€‚ç³»ç»Ÿéœ€æ ¡éªŒè¯„è®ºå­˜åœ¨æ€§ã€ç¡®è®¤è¯„è®ºå±äºç›®æ ‡è§†é¢‘ï¼Œå¹¶éªŒè¯æ“ä½œè€…å¯¹è¯¥è§†é¢‘æ‹¥æœ‰ç®¡ç†æƒé™ã€‚è‹¥ç³»åˆ—ä¸­å·²æœ‰å…¶ä»–ç½®é¡¶è¯„è®ºï¼Œåº”å–æ¶ˆåŸç½®é¡¶åå†è®¾ç½®æ–°çš„ç½®é¡¶ã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ASCII æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ï¼šPOST /comment/topComment                            â”‚
â”‚ Payload: { "commentId": 345678 }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ§åˆ¶å™¨ï¼šVideoCommentController#topComment âœ…               â”‚
â”‚ 1. Token â†’ currentUserId                                  â”‚
â”‚ 2. videoCommentService.topComment(commentId, userId)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡ï¼šVideoCommentService.topComment âœ…                    â”‚
â”‚ 1. æŸ¥è¯¢è¯„è®ºä¿¡æ¯ â†’ è·å– videoId & ä½œè€…ä¿¡æ¯                 â”‚
â”‚ 2. éªŒè¯ userId æ˜¯å¦ä¸ºè§†é¢‘ä½œè€…ï¼ˆæˆ–ç®¡ç†å‘˜ï¼‰                 â”‚
â”‚ 3. å¦‚æœè¯¥è§†é¢‘å·²æœ‰ç½®é¡¶è¯„è®º â†’ å…ˆå–æ¶ˆ                        â”‚
â”‚ 4. æ›´æ–° comment.topType = TOP                             â”‚
â”‚ 5. è®°å½•æ“ä½œï¼ˆå¯é€‰ï¼šç³»ç»Ÿæ¶ˆæ¯/æ—¥å¿—ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯
1. **ä½œè€…ç½®é¡¶è‡ªå·±çš„è§†é¢‘è¯„è®º**ï¼šæ“ä½œæˆåŠŸï¼ŒåŸç½®é¡¶è¯„è®ºï¼ˆå¦‚æœ‰ï¼‰è¢«å–æ¶ˆï¼Œæ–°è¯„è®ºç½®é¡¶ã€‚
2. **è¶Šæƒç½®é¡¶**ï¼šæ“ä½œè€…ä¸æ˜¯è§†é¢‘ä½œè€…ï¼ŒæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆCODE_600ï¼‰ã€‚
3. **è¯„è®ºä¸å­˜åœ¨æˆ–å·²åˆ é™¤**ï¼šæŸ¥è¯¢è¿”å›ç©ºï¼ŒæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆCODE_600ï¼‰ã€‚

### Mermaid æµç¨‹å›¾
```mermaid
graph TD
    A["è¯·æ±‚: POST /comment/topComment<br/>commentId"] --> B["æ§åˆ¶å™¨: VideoCommentController âœ…<br/>currentUserId"]
    B --> C["æœåŠ¡: topComment(commentId, userId) âœ…"]
    C --> C1{"è¯„è®ºå­˜åœ¨?"}
    C1 -->|å¦| C2["BusinessException CODE_600 âŒ"]
    C1 -->|æ˜¯| C3["æ ¡éªŒè§†é¢‘å½’å±/æƒé™ âœ…"]
    C3 --> C4{"å·²æœ‰ç½®é¡¶è¯„è®º?"}
    C4 -->|æ˜¯| C5["å–æ¶ˆæ—§ç½®é¡¶ âœ…"]
    C4 -->|å¦| C6["ç›´æ¥ç½®é¡¶ âœ…"]
    C5 --> C6
    C6 --> D["æ›´æ–°è¯„è®ºçŠ¶æ€ â†’ è¿”å›æˆåŠŸ"]
```

---

## ğŸ“¦ è®¾è®¡å…ƒç´ æ¸…å•

### âœ… å·²å­˜åœ¨çš„è®¾è®¡
- æ§åˆ¶å™¨ï¼š`VideoCommentController#topComment`ï¼ˆ`easylive-java/.../VideoCommentController.java:227`ï¼‰
- æœåŠ¡æ¥å£ï¼š`VideoCommentService#topComment` & `cancelTopComment`ï¼ˆå…·ä½“å®ç°éœ€æŸ¥çœ‹ serviceï¼‰
- DDD èšåˆï¼š
  - `VideoComment` èšåˆæœªæ˜¾ç¤ºï¼Œä½†ç›¸å…³å‘½ä»¤/äº‹ä»¶å¯åœ¨ `video_comment` è®¾è®¡ä¸­æŸ¥æ‰¾  
  - `CommentTopTypeEnum` æšä¸¾è¡¨ç¤ºç½®é¡¶çŠ¶æ€  
  - å‘½ä»¤ï¼ˆéœ€è¡¥å……ï¼‰ï¼š`TopVideoCommentCmd`ã€`CancelTopVideoCommentCmd`ï¼ˆå‡è®¾å­˜åœ¨æˆ–éœ€æ·»åŠ ï¼‰
- ç°æœ‰æµç¨‹ä½¿ç”¨ä¼ ç»Ÿ service æ“ä½œï¼Œæœªä½¿ç”¨äº‹ä»¶é©±åŠ¨ã€‚

---

## âŒ ç¼ºå¤±çš„è®¾è®¡æ¸…å•

| ç±»å‹ | ç¼ºå¤±é¡¹ | æè¿° | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|------|--------|------|----------|-------|
| å‘½ä»¤ | `TopVideoCommentCmd` | æ ¹æ® commentId è®¾ç½®ç½®é¡¶ï¼Œå¹¶å¤„ç†åŸç½®é¡¶è¯„è®º | `design/aggregate/video_comment/_gen.json` | P0 |
| å‘½ä»¤ | `CancelTopVideoCommentCmd` | å–æ¶ˆç½®é¡¶ï¼ˆç”¨äºå·²æœ‰ç½®é¡¶çš„æƒ…å†µï¼‰ | åŒä¸Š | P0 |
| éªŒè¯å™¨ | `@VideoCommentOwner` | æ ¡éªŒè¯„è®ºå½’å±è§†é¢‘ï¼Œå¹¶éªŒè¯è§†é¢‘ä½œè€… | `only-danmuku-application/.../validator/` | P0 |
| æŸ¥è¯¢ | `GetVideoCommentDetailQry` | æ ¹æ® commentId è¿”å›è¯¦æƒ…ï¼ˆå« videoIdã€ä½œè€…ï¼‰ | `design/aggregate/video_comment/_gen.json` | P0 |
| äº‹ä»¶ | `VideoCommentTopChangedDomainEvent` | ç½®é¡¶å˜æ›´åé€šçŸ¥å‰ç«¯åˆ·æ–°æˆ–è®°å½•æ—¥å¿— | `design/aggregate/video_comment/_gen.json` | P1 |
| äº‹ä»¶å¤„ç†å™¨ | `VideoCommentTopChangedEventHandler` | åˆ·æ–°ç¼“å­˜ã€æ¨é€é€šçŸ¥ | `only-danmuku-adapter/.../events/VideoCommentTopChangedEventHandler.kt` | P1 |

---

## ğŸ”‘ å…³é”®ä¸šåŠ¡è§„åˆ™
- **æƒé™**ï¼šåªæœ‰è§†é¢‘ä½œè€…æˆ–å…·å¤‡ç®¡ç†æƒé™çš„ç”¨æˆ·å¯ç½®é¡¶è¯„è®ºã€‚
- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªè§†é¢‘æœ€å¤šåªæœ‰ä¸€æ¡ç½®é¡¶è¯„è®ºï¼Œç½®é¡¶æ–°è¯„è®ºæ—¶éœ€å–æ¶ˆæ—§çš„ã€‚
- **çŠ¶æ€ç»´æŠ¤**ï¼š`VideoComment` ä¸­åº”é€šè¿‡æšä¸¾æˆ–å¸ƒå°”å­—æ®µè¡¨ç¤ºç½®é¡¶çŠ¶æ€ï¼›å–æ¶ˆç½®é¡¶æ—¶æ¢å¤ä¸ºæ™®é€šçŠ¶æ€ã€‚
- **å±•ç¤ºåŒæ­¥**ï¼šç½®é¡¶å˜æ›´ååº”åˆ·æ–°å®¢æˆ·ç«¯è¯„è®ºåˆ—è¡¨ç¼“å­˜ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ã€‚
- **å®¡è®¡**ï¼šå»ºè®®è®°å½•ç½®é¡¶æ“ä½œæ—¥å¿—ï¼ˆæ“ä½œè€…ã€ç›®æ ‡è¯„è®ºã€æ—¶é—´ï¼‰ã€‚

---

## ğŸ§¾ æ§åˆ¶å™¨ä¸å‘½ä»¤ç¤ºä¾‹
```java
@RequestMapping("/topComment")
@GlobalInterceptor(checkLogin = true)
public ResponseVO topComment(@NotNull Integer commentId) {
    TokenUserInfoDto tokenUserInfoDto = getTokenUserInfoDto();
    videoCommentService.topComment(commentId, tokenUserInfoDto.getUserId());
    return getSuccessResponseVO(null);
}
```
> å‚è€ƒï¼š`easylive-java/easylive-web/src/main/java/com/easylive/web/controller/VideoCommentController.java:227`

```kotlin
// DDD å‘½ä»¤å»ºè®®å®ç°
val comment = Mediator.repositories.findFirst(
    SVideoComment.predicateById(request.commentId),
    persist = false
).getOrNull() ?: throw KnownException("è¯„è®ºä¸å­˜åœ¨ï¼š${request.commentId}")
val video = comment.video ?: throw KnownException("è¯„è®ºæ— è§†é¢‘å…³è”")
if (video.customerId != request.userId) {
    throw KnownException("æ— æƒç½®é¡¶è¯¥è¯„è®º")
}
video.updateTopComment(comment)
Mediator.uow.save()
```

---

## ğŸ“‚ ä¼ ç»Ÿæ¶æ„å‚è€ƒ
- æ§åˆ¶å™¨ï¼š`easylive-java/easylive-web/src/main/java/com/easylive/web/controller/VideoCommentController.java:227`
- ç›¸å…³æšä¸¾ï¼š`CommentTopTypeEnum`
- æœåŠ¡å®ç°ï¼ˆéœ€ç»“åˆ `VideoCommentServiceImpl` æŸ¥çœ‹å…·ä½“ç»†èŠ‚ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

