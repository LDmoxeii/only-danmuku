# è¯„è®ºåˆ é™¤æµç¨‹è®¾è®¡æ–‡æ¡£

> åŸºäº easylive-java é¡¹ç›®éœ€æ±‚ï¼ŒæŒ‰ç…§ DDD äº‹ä»¶é©±åŠ¨æ¨¡å¼è®¾è®¡

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ¦‚è¿°

ç®¡ç†å‘˜æˆ–ç”¨æˆ·åˆ é™¤è§†é¢‘è¯„è®ºï¼Œç³»ç»ŸéªŒè¯è¯„è®ºå­˜åœ¨æ€§ã€æƒé™ï¼ˆç®¡ç†å‘˜å¯åˆ é™¤æ‰€æœ‰ã€UPä¸»å¯åˆ é™¤è‡ªå·±è§†é¢‘çš„è¯„è®ºã€ç”¨æˆ·å¯åˆ é™¤è‡ªå·±å‘è¡¨çš„è¯„è®ºï¼‰ï¼Œåˆ é™¤è¯„è®ºè®°å½•ï¼Œä¸€çº§è¯„è®ºéœ€æ›´æ–°è§†é¢‘è¯„è®ºç»Ÿè®¡å¹¶çº§è”åˆ é™¤æ‰€æœ‰äºŒçº§å›å¤ã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ASCII æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ï¼šPOST /interact/delComment                                  â”‚
â”‚ Payload:                                                        â”‚
â”‚ {                                                               â”‚
â”‚   "commentId": 123456                                           â”‚
â”‚ }                                                               â”‚
â”‚                                                                 â”‚
â”‚ åœºæ™¯ï¼š                                                           â”‚
â”‚   - ç®¡ç†å‘˜åˆ é™¤è¿è§„è¯„è®ºï¼ˆç®¡ç†åå°ï¼‰                                â”‚
â”‚   - UPä¸»åˆ é™¤è‡ªå·±è§†é¢‘çš„è¯„è®ºï¼ˆç”¨æˆ·ç«¯ï¼‰                               â”‚
â”‚   - ç”¨æˆ·åˆ é™¤è‡ªå·±å‘è¡¨çš„è¯„è®ºï¼ˆç”¨æˆ·ç«¯ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šDelCommentCmd                                              â”‚
â”‚ çŠ¶æ€ï¼šâœ… å·²å®šä¹‰ (design/aggregate/video_comment/_gen.json:10)   â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - commentId: Int                                              â”‚
â”‚   - operatorId: String? (å¯é€‰ï¼Œç”¨äºæƒé™æ ¡éªŒ)                     â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â”œâ”€ @CommentExists âœ… (éªŒè¯è¯„è®ºå­˜åœ¨ï¼Œä¾èµ– CommentExistsByIdQry) â”‚
â”‚   â””â”€ @CommentDeletePermission âœ… (éªŒè¯åˆ é™¤æƒé™)                  â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢è¯„è®ºä¿¡æ¯ GetCommentByIdQry âœ…                           â”‚
â”‚      - å¦‚æœä¸å­˜åœ¨ â†’ æŠ›å‡ºå¼‚å¸¸ "è¯„è®ºä¸å­˜åœ¨"                         â”‚
â”‚   2. æƒé™æ ¡éªŒ (å¦‚æœ operatorId ä¸ä¸º null):                       â”‚
â”‚      - æ£€æŸ¥ operatorId == comment.videoOwnerId (UPä¸»)           â”‚
â”‚      - æˆ– operatorId == comment.userId (è¯„è®ºä½œè€…)               â”‚
â”‚      - å¦‚æœéƒ½ä¸åŒ¹é… â†’ æŠ›å‡ºå¼‚å¸¸ "æ— æƒé™åˆ é™¤è¯¥è¯„è®º"                  â”‚
â”‚      - ç®¡ç†å‘˜æ“ä½œæ—¶ operatorId = nullï¼Œè·³è¿‡æƒé™æ ¡éªŒ               â”‚
â”‚   3. VideoComment.markAsDeleted()                               â”‚
â”‚      - åˆ é™¤è¯„è®ºè®°å½•                                              â”‚
â”‚      - è‹¥ä¸ºä¸€çº§è¯„è®ºï¼Œå‘½ä»¤å†…éƒ¨åŒæ­¥åˆ é™¤å…¨éƒ¨äºŒçº§å›å¤                â”‚
â”‚   4. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCommentDeletedDomainEvent                              â”‚
â”‚ çŠ¶æ€ï¼šâœ… å·²å®šä¹‰ (design/aggregate/video_comment/_gen.json:52)   â”‚
â”‚                                                                 â”‚
â”‚ äº‹ä»¶è½½è·ï¼š                                                       â”‚
â”‚ {                                                               â”‚
â”‚   "commentId": 123456,                                          â”‚
â”‚   "videoId": "V123456789",                                      â”‚
â”‚   "pCommentId": 0,           // 0=ä¸€çº§è¯„è®º, >0=äºŒçº§å›å¤          â”‚
â”‚   "deletedBy": "admin" | "uploader" | "author",  // åˆ é™¤è€…ç±»å‹   â”‚
â”‚   "operatorId": "U001" | null,                                  â”‚
â”‚   "deleteTime": 1729267200                                      â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ pCommentId?     â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â†“       â†“
              0 (ä¸€çº§è¯„è®º)          >0 (äºŒçº§å›å¤)
                         â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†æ”¯ #1: ä¸€çº§è¯„è®ºåˆ é™¤                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶ç›‘å¬å™¨ï¼šCommentDeletedDomainEventSubscriber âœ…              â”‚
â”‚ ç›‘å¬äº‹ä»¶ï¼šCommentDeletedDomainEvent (pCommentId == 0)           â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼š                                                       â”‚
â”‚   1. UpdateVideoStatisticsCmd âœ… (æ›´æ–°è§†é¢‘è¯„è®ºæ•° -1)             â”‚
â”‚   2. ï¼ˆDelCommentCmd å·²åœ¨å‘½ä»¤å†…åŒæ­¥æ¸…ç†æ‰€æœ‰å­è¯„è®ºï¼‰               â”‚
â”‚ å®ç°è·¯å¾„ï¼šonly-danmuku-application/src/main/kotlin/edu/only4/danmuku/application/subscribers/domain/video_comment/CommentDeletedDomainEventSubscriber.kt â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šUpdateVideoStatisticsCmd âœ…                                â”‚
â”‚ çŠ¶æ€ï¼šå·²å®ç°                                                     â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - videoId: Long                                               â”‚
â”‚   - commentCountDelta: Int (å¯æ­£å¯è´Ÿï¼Œå‘½ä»¤å†…éƒ¨é˜²æ­¢å‡ºç°è´Ÿå€¼)        â”‚
â”‚   - å…¶ä½™å¢é‡å­—æ®µåœ¨éœ€è¦æ—¶å¡«å†™                                     â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. åŠ è½½è§†é¢‘èšåˆ (SVideo)                                       â”‚
â”‚   2. æ ¹æ®å¢é‡æ›´æ–°å„ç»Ÿè®¡å­—æ®µï¼Œæœ€å°å€¼ä¸º 0                         â”‚
â”‚   3. æŒä¹…åŒ–ä¿®æ”¹å¹¶è¿”å›æœ€æ–°ç»Ÿè®¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                             â†“
                      âœ… ä¸€çº§è¯„è®ºåˆ é™¤å®Œæˆ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†æ”¯ #2: äºŒçº§å›å¤åˆ é™¤                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶ç›‘å¬å™¨ï¼šCommentDeletedDomainEventSubscriber âœ…              â”‚
â”‚ ç›‘å¬äº‹ä»¶ï¼šCommentDeletedDomainEvent (pCommentId > 0)            â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼šæ—  (äºŒçº§å›å¤åˆ é™¤ä¸æ›´æ–°è§†é¢‘ç»Ÿè®¡ï¼Œä¸çº§è”åˆ é™¤)             â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   - è®°å½•å®¡è®¡æ—¥å¿—                                                 â”‚
â”‚   - å¯é€‰ï¼šé€šçŸ¥è¢«å›å¤è€… (æ‚¨æ”¶åˆ°çš„å›å¤å·²è¢«åˆ é™¤)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                      âœ… äºŒçº§å›å¤åˆ é™¤å®Œæˆ
```

---

### Mermaid å¯è§†åŒ–æµç¨‹å›¾

```mermaid
graph TD
    A[è¯·æ±‚: POST /interact/delComment<br/>commentId] --> B[å‘½ä»¤: DelCommentCmd âœ…]

    B --> B1[éªŒè¯å™¨: @CommentExists âŒ<br/>éªŒè¯è¯„è®ºå­˜åœ¨]
    B --> B2[éªŒè¯å™¨: @CommentDeletePermission âŒ<br/>éªŒè¯åˆ é™¤æƒé™]
    B --> B3[æŸ¥è¯¢: GetCommentByIdQry âœ…<br/>è·å–è¯„è®ºä¿¡æ¯]
    B --> B4[æŸ¥è¯¢: GetVideoInfoQry âœ…<br/>è·å–è§†é¢‘ä¿¡æ¯]

    B4 --> B5{operatorId æ˜¯å¦ä¸º null?}
    B5 -->|null ç®¡ç†å‘˜| B6[è·³è¿‡æƒé™æ ¡éªŒ<br/>ç®¡ç†å‘˜å¯åˆ é™¤æ‰€æœ‰è¯„è®º]
    B5 -->|énull ç”¨æˆ·| B7[æƒé™æ ¡éªŒ<br/>UPä¸» OR è¯„è®ºä½œè€…]

    B7 --> B7A{operatorId == video.userId?}
    B7A -->|æ˜¯| B8[UPä¸»æƒé™é€šè¿‡]
    B7A -->|å¦| B7B{operatorId == comment.userId?}
    B7B -->|æ˜¯| B8
    B7B -->|å¦| B7C[æŠ›å‡ºå¼‚å¸¸: æ— æƒé™]

    B6 --> C[VideoComment.markAsDeleted<br/>åˆ é™¤è¯„è®ºè®°å½•]
    B8 --> C

    C --> C4[è‹¥ä¸ºä¸€çº§è¯„è®º: å‘½ä»¤å†…åŒæ­¥åˆ é™¤å­è¯„è®º âœ…]
    C --> D[é¢†åŸŸäº‹ä»¶: CommentDeletedDomainEvent âœ…<br/>commentId, videoId, pCommentId, deletedBy, operatorId]

    D --> E{pCommentId == 0?}
    E -->|æ˜¯ ä¸€çº§è¯„è®º| F1[äº‹ä»¶ç›‘å¬å™¨: CommentDeletedDomainEventSubscriber âœ…<br/>ä¸€çº§è¯„è®ºåˆ†æ”¯]
    E -->|å¦ äºŒçº§å›å¤| F2[äº‹ä»¶ç›‘å¬å™¨: CommentDeletedDomainEventSubscriber âœ…<br/>äºŒçº§å›å¤åˆ†æ”¯]

    F1 --> G1[å‘½ä»¤: UpdateVideoStatisticsCmd âœ…<br/>commentCountDelta=-1]

    G1 --> H1[âœ… ä¸€çº§è¯„è®ºåˆ é™¤å®Œæˆ<br/>è§†é¢‘ç»Ÿè®¡å·²æ›´æ–°, å­è¯„è®ºå·²åˆ é™¤]

    F2 --> H2[è®°å½•å®¡è®¡æ—¥å¿—<br/>å¯é€‰: é€šçŸ¥è¢«å›å¤è€…]
    H2 --> H3[âœ… äºŒçº§å›å¤åˆ é™¤å®Œæˆ<br/>ä¸æ›´æ–°è§†é¢‘ç»Ÿè®¡]

    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    style B fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style D fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style H1 fill:#C8E6C9,stroke:#388E3C,stroke-width:3px
    style H3 fill:#C8E6C9,stroke:#388E3C,stroke-width:3px

    style B1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style B2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style B7C fill:#FFC107,stroke:#F57C00,stroke-width:2px
```

**å›¾ä¾‹è¯´æ˜**ï¼š
- ğŸ”µ è“è‰²ï¼šè¯·æ±‚å…¥å£
- ğŸŸ¢ ç»¿è‰²ï¼šå·²å­˜åœ¨çš„è®¾è®¡ï¼ˆâœ… å¯ç›´æ¥ä½¿ç”¨ï¼‰
- ğŸ”´ çº¢è‰²ï¼šç¼ºå¤±çš„è®¾è®¡ï¼ˆâŒ éœ€å®ç°ï¼‰
- ğŸŸ¡ é»„è‰²ï¼šå¼‚å¸¸åˆ†æ”¯

---

## ğŸ“¦ è®¾è®¡å…ƒç´ æ¸…å•

### âœ… å·²å­˜åœ¨çš„è®¾è®¡

#### å‘½ä»¤ (Commands)

| å‘½ä»¤ | æè¿° | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `DelCommentCmd` | åˆ é™¤è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:10` |
| `PostCommentCmd` | å‘è¡¨è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:5` |
| `ReplyCommentCmd` | å›å¤è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:35` |

#### é¢†åŸŸäº‹ä»¶ (Domain Events)

| äº‹ä»¶ | æè¿° | è§¦å‘æ—¶æœº | çŠ¶æ€ | ä½ç½® |
|------|------|----------|------|------|
| `CommentDeletedDomainEvent` | è¯„è®ºå·²åˆ é™¤ | è¯„è®ºåˆ é™¤å | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:52` |
| `CommentPostedDomainEvent` | è¯„è®ºå·²å‘è¡¨ | è¯„è®ºå‘è¡¨å | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:42` |

#### æŸ¥è¯¢ (Queries)

| æŸ¥è¯¢ | æè¿° | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `GetCommentByIdQry` | æ ¹æ®IDè·å–è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:119` |
| `GetCommentRepliesQry` | è·å–è¯„è®ºå›å¤åˆ—è¡¨ | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:124` |
| `GetVideoInfoQry` | è·å–è§†é¢‘ä¿¡æ¯ | âœ… å·²å®šä¹‰ | `design/aggregate/video/_gen.json:94` |

---

### âŒ ç¼ºå¤±çš„è®¾è®¡æ¸…å•

#### éœ€è¦è¡¥å……çš„å‘½ä»¤

| åºå· | å‘½ä»¤åç§° | æè¿° | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|----------|-------|
| 1 | `UpdateVideoStatisticsCmd` | æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯ï¼ˆç‚¹èµ/æ”¶è—/æŠ•å¸/è¯„è®ºæ•°ï¼‰ | `design/extra/video_statistics_gen.json` | P0 |

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/video_statistics_gen.json`ï¼‰ï¼š
```json
{
  "cmd": [
    {
      "package": "video",
      "name": "UpdateVideoStatistics",
      "desc": "æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯"
    }
  ]
}
```

#### éœ€è¦è¡¥å……çš„é¢†åŸŸäº‹ä»¶

| åºå· | äº‹ä»¶åç§° | æè¿° | è§¦å‘æ—¶æœº | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|----------|----------|-------|
| 1 | `VideoStatisticsUpdatedDomainEvent` | è§†é¢‘ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–° | è§†é¢‘ç»Ÿè®¡æ›´æ–°å | `design/extra/video_statistics_gen.json` | P1 |

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/video_statistics_gen.json`ï¼‰ï¼š
```json
{
  "de": [
    {
      "package": "video",
      "name": "VideoStatisticsUpdated",
      "desc": "è§†é¢‘ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°",
      "aggregates": ["Video"],
      "entity": "Video",
      "persist": true
    }
  ]
}
```

#### éœ€è¦è¡¥å……çš„éªŒè¯å™¨

| åºå· | éªŒè¯å™¨åç§°                      | æè¿°                   | ä¾èµ–æŸ¥è¯¢                                           | å®ç°è·¯å¾„                                                   | ä¼˜å…ˆçº§ |
|----|----------------------------|----------------------|------------------------------------------------|--------------------------------------------------------|-----|
| 1  | `@CommentExists`           | éªŒè¯è¯„è®ºå­˜åœ¨               | `CommentExistsByIdQry`                         | `application/.../validater/CommentExists.kt`           | âœ…   |
| 2  | `@CommentDeletePermission` | éªŒè¯åˆ é™¤æƒé™ï¼ˆç®¡ç†å‘˜/UPä¸»/è¯„è®ºä½œè€…ï¼‰ | `CommentExistsByIdQry`<br/>`GetCommentByIdQry` | `application/.../validater/CommentDeletePermission.kt` | âœ…   |

#### âœ… å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨

| åºå· | ç›‘å¬å™¨åç§°                                 | ç›‘å¬äº‹ä»¶                        | è§¦å‘å‘½ä»¤                              | å®ç°è·¯å¾„                                                                                                                                             |
|----|---------------------------------------|-----------------------------|-----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| 1  | `CommentDeletedDomainEventSubscriber` | `CommentDeletedDomainEvent` | `UpdateVideoStatisticsCmd`ï¼ˆä»…ä¸€çº§è¯„è®ºï¼‰ | `only-danmuku-application/src/main/kotlin/edu/only4/danmuku/application/subscribers/domain/video_comment/CommentDeletedDomainEventSubscriber.kt` |

**ä¼˜å…ˆçº§è¯´æ˜**ï¼š
- **P0**ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å®ç°
- **P1**ï¼šé‡è¦åŠŸèƒ½ï¼Œå»ºè®®å®ç°
- **P2**ï¼šå¯é€‰åŠŸèƒ½ï¼Œåç»­æ‰©å±•

---

## ğŸ”‘ å…³é”®ä¸šåŠ¡è§„åˆ™

### 1. ä¸‰çº§æƒé™æ§åˆ¶
- **ç®¡ç†å‘˜åˆ é™¤**ï¼š
  - `operatorId = null`
  - å¯åˆ é™¤ä»»ä½•è¯„è®ºï¼Œæ— éœ€æƒé™æ ¡éªŒ
  - ç”¨äºå¤„ç†è¿è§„å†…å®¹

- **UPä¸»åˆ é™¤**ï¼š
  - `operatorId = å½“å‰ç”¨æˆ·ID`
  - å¯åˆ é™¤è‡ªå·±è§†é¢‘çš„æ‰€æœ‰è¯„è®º
  - æƒé™æ ¡éªŒï¼š`operatorId == video.userId`

- **è¯„è®ºä½œè€…åˆ é™¤**ï¼š
  - `operatorId = å½“å‰ç”¨æˆ·ID`
  - åªèƒ½åˆ é™¤è‡ªå·±å‘è¡¨çš„è¯„è®º
  - æƒé™æ ¡éªŒï¼š`operatorId == comment.userId`

**æƒé™æ ¡éªŒé€»è¾‘**ï¼š
```kotlin
fun hasDeletePermission(operatorId: String?, comment: VideoComment, video: Video): Boolean {
    // ç®¡ç†å‘˜æ¨¡å¼
    if (operatorId == null) return true

    // UPä¸» æˆ– è¯„è®ºä½œè€…
    return operatorId == video.userId || operatorId == comment.userId
}
```

### 2. ä¸€çº§è¯„è®º vs äºŒçº§å›å¤çš„åˆ é™¤å·®å¼‚

| ç‰¹æ€§         | ä¸€çº§è¯„è®º (`pCommentId = 0`)                  | äºŒçº§å›å¤ (`pCommentId > 0`) |
|------------|------------------------------------------|-------------------------|
| **æ›´æ–°è§†é¢‘ç»Ÿè®¡** | âœ… éœ€è¦æ›´æ–° `comment_count -1`                | âŒ ä¸æ›´æ–°ç»Ÿè®¡                 |
| **çº§è”åˆ é™¤**   | âœ… åˆ é™¤æ‰€æœ‰å­è¯„è®º                                | âŒ ä¸çº§è”åˆ é™¤                 |
| **äº‹ä»¶å¤„ç†**   | è§¦å‘ `UpdateVideoStatisticsCmd`ï¼›å­è¯„è®ºå·²åœ¨å‘½ä»¤å†…åˆ é™¤ | ä»…è®°å½•æ—¥å¿—                   |

**åˆ¤æ–­é€»è¾‘**ï¼š
```kotlin
if (comment.parentId == 0L) {
    // ä¸€çº§è¯„è®ºï¼šå‘½ä»¤å†…ç›´æ¥åˆ é™¤æ‰€æœ‰å­è¯„è®º
    Mediator.repositories.remove(
        SVideoComment.predicate { schema ->
            schema.parentId eq comment.id
        }
    )
}
Mediator.repositories.remove(SVideoComment.predicateById(comment.id))
Mediator.uow.save()
```

### 3. çº§è”åˆ é™¤å­è¯„è®º

**åœºæ™¯**ï¼šåˆ é™¤ä¸€çº§è¯„è®ºæ—¶ï¼Œéœ€åŒæ—¶åˆ é™¤æ‰€æœ‰äºŒçº§å›å¤

**å®ç°æ–¹å¼**ï¼šåœ¨ `DelCommentCmd` ä¸­ç›´æ¥ä½¿ç”¨ä»“å‚¨ä¸€æ¬¡æ€§åˆ é™¤ `parentId = commentId` çš„æ‰€æœ‰è¯„è®ºè®°å½•ï¼Œé¿å…é¢å¤–å‘½ä»¤å’Œäº‹ä»¶é“¾è·¯ã€‚

**SQL ç¤ºä¾‹**ï¼ˆeasylive-java å®ç°ï¼‰ï¼š
```sql
DELETE FROM video_comment
WHERE p_comment_id = #{commentId}
```

### 4. ç»Ÿè®¡æ›´æ–°è§„åˆ™

**ä½•æ—¶æ›´æ–°è§†é¢‘è¯„è®ºç»Ÿè®¡**ï¼š
- âœ… åˆ é™¤ä¸€çº§è¯„è®º â†’ `comment_count -1`
- âŒ åˆ é™¤äºŒçº§å›å¤ â†’ ä¸æ›´æ–°ç»Ÿè®¡

**åŸå› **ï¼š
- è§†é¢‘çš„ `comment_count` åªç»Ÿè®¡ä¸€çº§è¯„è®ºæ•°é‡
- äºŒçº§å›å¤è¢«è§†ä¸ºä¸€çº§è¯„è®ºçš„é™„å±å†…å®¹
- ç¬¦åˆ easylive-java çš„è®¾è®¡ï¼ˆ`VideoCommentServiceImpl.deleteComment:345-347`ï¼‰

### 5. å®¡è®¡æ—¥å¿—

**è®°å½•å†…å®¹**ï¼š
- åˆ é™¤æ—¶é—´ï¼š`deleteTime`
- åˆ é™¤è€…ç±»å‹ï¼š`deletedBy = "admin" | "uploader" | "author"`
- æ“ä½œè€…IDï¼š`operatorId`
- è¢«åˆ é™¤è¯„è®ºä¿¡æ¯ï¼š`commentId, videoId, pCommentId, content`
- è¯„è®ºå±‚çº§ï¼š`pCommentId == 0 ? "ä¸€çº§è¯„è®º" : "äºŒçº§å›å¤"`

**ç”¨é€”**ï¼š
- ç®¡ç†å‘˜æ“ä½œè¿½æº¯
- çº çº·å¤„ç†è¯æ®
- æ•°æ®æ¢å¤ä¾æ®ï¼ˆå¦‚æœä½¿ç”¨è½¯åˆ é™¤ï¼‰

---

## ğŸ“Š Controller å±‚å®ç°ç¤ºä¾‹

### ç®¡ç†åå°åˆ é™¤

```kotlin
@RestController
@RequestMapping("/admin/interact")
class AdminInteractController {

    @PostMapping("/delComment")
    fun delComment(
        @RequestParam @NotNull commentId: Int
    ): Response {
        // ç®¡ç†å‘˜åˆ é™¤ï¼šoperatorId = nullï¼Œæ— æƒé™é™åˆ¶
        Mediator.commands.send(
            DelCommentCmd.Request(
                commentId = commentId,
                operatorId = null  // ç®¡ç†å‘˜æ ‡è¯†
            )
        )
        return Response()
    }
}
```

### ç”¨æˆ·ç«¯åˆ é™¤

```kotlin
@RestController
@RequestMapping("/api/comment")
class UserCommentController {

    @PostMapping("/delete")
    fun deleteComment(
        @RequestParam @NotNull commentId: Int
    ): Response {
        val currentUserId = LoginHelper.getUserId()!!

        // ç”¨æˆ·åˆ é™¤ï¼šéœ€éªŒè¯æƒé™ï¼ˆUPä¸» æˆ– è¯„è®ºä½œè€…ï¼‰
        Mediator.commands.send(
            DelCommentCmd.Request(
                commentId = commentId,
                operatorId = currentUserId
            )
        )
        return Response()
    }
}
```

---

## ğŸ“Œ è®¾è®¡ä¼˜åŠ¿

### **ä¸‰çº§æƒé™ + åŒåˆ†æ”¯å¤„ç†**

1. **çµæ´»çš„æƒé™æ§åˆ¶**ï¼š
   - å•ä¸€å‘½ä»¤æ”¯æŒä¸‰ç§åˆ é™¤åœºæ™¯ï¼ˆç®¡ç†å‘˜/UPä¸»/è¯„è®ºä½œè€…ï¼‰
   - é€šè¿‡ `operatorId` å‚æ•°ä¼˜é›…å®ç°æƒé™åˆ†ç¦»

2. **æ™ºèƒ½çº§è”åˆ é™¤**ï¼š
   - ä¸€çº§è¯„è®ºåˆ é™¤ â†’ è‡ªåŠ¨æ¸…ç†æ‰€æœ‰å­è¯„è®º
   - äºŒçº§å›å¤åˆ é™¤ â†’ ç‹¬ç«‹åˆ é™¤ï¼Œä¸å½±å“çˆ¶è¯„è®º

3. **ç²¾å‡†ç»Ÿè®¡æ›´æ–°**ï¼š
   - åªæœ‰ä¸€çº§è¯„è®ºåˆ é™¤æ‰æ›´æ–°è§†é¢‘ç»Ÿè®¡
   - é¿å…ç»Ÿè®¡æ•°æ®é”™è¯¯

4. **äº‹ä»¶é©±åŠ¨è®¾è®¡**ï¼š
   - é€šè¿‡äº‹ä»¶å¤„ç†å™¨è§£è€¦åˆ é™¤é€»è¾‘å’Œåç»­æ“ä½œ
   - ç»Ÿè®¡æ›´æ–°ã€çº§è”åˆ é™¤ã€æ—¥å¿—è®°å½•åˆ†ç¦»

---

## ğŸ”„ åˆ é™¤æµç¨‹å¯¹æ¯”è¡¨

| åˆ é™¤åœºæ™¯ | æƒé™è¦æ±‚ | æ›´æ–°ç»Ÿè®¡ | çº§è”åˆ é™¤ | äº‹ä»¶å¤„ç† |
|---------|---------|---------|---------|---------|
| **ç®¡ç†å‘˜åˆ é™¤ä¸€çº§è¯„è®º** | `operatorId = null` | âœ… `comment_count -1` | âœ… åˆ é™¤æ‰€æœ‰å­è¯„è®º | 2ä¸ªå‘½ä»¤ |
| **ç®¡ç†å‘˜åˆ é™¤äºŒçº§å›å¤** | `operatorId = null` | âŒ ä¸æ›´æ–° | âŒ ä¸çº§è” | ä»…æ—¥å¿— |
| **UPä¸»åˆ é™¤ä¸€çº§è¯„è®º** | `operatorId == video.userId` | âœ… `comment_count -1` | âœ… åˆ é™¤æ‰€æœ‰å­è¯„è®º | 2ä¸ªå‘½ä»¤ |
| **UPä¸»åˆ é™¤äºŒçº§å›å¤** | `operatorId == video.userId` | âŒ ä¸æ›´æ–° | âŒ ä¸çº§è” | ä»…æ—¥å¿— |
| **ä½œè€…åˆ é™¤è‡ªå·±çš„ä¸€çº§è¯„è®º** | `operatorId == comment.userId` | âœ… `comment_count -1` | âœ… åˆ é™¤æ‰€æœ‰å­è¯„è®º | 2ä¸ªå‘½ä»¤ |
| **ä½œè€…åˆ é™¤è‡ªå·±çš„äºŒçº§å›å¤** | `operatorId == comment.userId` | âŒ ä¸æ›´æ–° | âŒ ä¸çº§è” | ä»…æ—¥å¿— |

---

## ğŸ§© æ‰©å±•è®¾è®¡ï¼šæ‰¹é‡åˆ é™¤è¯„è®º

å¦‚æœéœ€è¦æ‰¹é‡åˆ é™¤è¿è§„è¯„è®ºï¼ˆä¾‹å¦‚åˆ é™¤æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è¯„è®ºï¼‰ï¼Œå¯ä»¥æ–°å¢ `BatchDeleteCommentsCmd`ï¼š

```kotlin
@PostMapping("/batchDelComments")
fun batchDelComments(
    @RequestParam userId: String?,
    @RequestParam videoId: String?
): Response {
    Mediator.commands.send(
        BatchDeleteCommentsCmd.Request(
            userId = userId,      // åˆ é™¤æŸç”¨æˆ·çš„æ‰€æœ‰è¯„è®º
            videoId = videoId,    // åˆ é™¤æŸè§†é¢‘çš„æ‰€æœ‰è¯„è®º
            operatorId = null     // ç®¡ç†å‘˜æ“ä½œ
        )
    )
    return Response()
}
```

**æ‰¹é‡åˆ é™¤æ³¨æ„äº‹é¡¹**ï¼š
- éœ€ç»Ÿè®¡ä¸€çº§è¯„è®ºæ•°é‡ï¼Œæ‰¹é‡æ›´æ–°è§†é¢‘ `comment_count`
- ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
- è®°å½•æ‰¹é‡æ“ä½œå®¡è®¡æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
