# ç”¨æˆ·è¡Œä¸º(ç‚¹èµ/æ”¶è—/æŠ•å¸)æµç¨‹è®¾è®¡æ–‡æ¡£

> åŸºäº easylive-java é¡¹ç›®éœ€æ±‚ï¼ŒæŒ‰ç…§ DDD äº‹ä»¶é©±åŠ¨æ¨¡å¼è®¾è®¡

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ¦‚è¿°

ç”¨æˆ·å¯¹è§†é¢‘æˆ–è¯„è®ºè¿›è¡Œäº’åŠ¨æ“ä½œï¼ˆç‚¹èµã€æ”¶è—ã€æŠ•å¸ã€è¯„è®ºç‚¹èµ/ç‚¹è¸©ï¼‰ï¼Œç³»ç»Ÿéœ€è¦è®°å½•ç”¨æˆ·è¡Œä¸ºã€æ›´æ–°ç»Ÿè®¡æ•°æ®ã€å¤„ç†ç¡¬å¸è½¬è´¦ï¼Œå¹¶æ”¯æŒå–æ¶ˆæ“ä½œã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ASCII æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ï¼šPOST /userAction/doAction                                  â”‚
â”‚ Payload:                                                        â”‚
â”‚ {                                                               â”‚
â”‚   "videoId": "V123456789",                                      â”‚
â”‚   "actionType": 2,  // 0-7: è¯„è®ºç‚¹èµ/è¸©/è§†é¢‘ç‚¹èµ/æ”¶è—/æŠ•å¸/...  â”‚
â”‚   "actionCount": 1, // æŠ•å¸æ•°é‡(1-2), å…¶ä»–é»˜è®¤1                  â”‚
â”‚   "commentId": 0    // è¯„è®ºID, 0è¡¨ç¤ºé’ˆå¯¹è§†é¢‘                     â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller å±‚ï¼šè·¯ç”±åˆ†å‘                                          â”‚
â”‚                                                                 â”‚
â”‚ when (actionType) {                                             â”‚
â”‚   VIDEO_LIKE    â†’ LikeVideoCmd         âŒ                       â”‚
â”‚   VIDEO_COLLECT â†’ CollectVideoCmd      âŒ                       â”‚
â”‚   VIDEO_COIN    â†’ GiveVideoCoinCmd     âŒ                       â”‚
â”‚   COMMENT_LIKE  â†’ LikeCommentCmd       âŒ                       â”‚
â”‚   COMMENT_HATE  â†’ DislikeCommentCmd    âŒ                       â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                    â†“                    â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµç¨‹åˆ†æ”¯ #1:     â”‚ â”‚ æµç¨‹åˆ†æ”¯ #2:     â”‚ â”‚ æµç¨‹åˆ†æ”¯ #3:     â”‚ â”‚ æµç¨‹åˆ†æ”¯ #4:     â”‚
â”‚ ç‚¹èµè§†é¢‘         â”‚ â”‚ æ”¶è—è§†é¢‘         â”‚ â”‚ æŠ•å¸è§†é¢‘         â”‚ â”‚ ç‚¹èµ/è¸©è¯„è®º      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                    â†“                    â†“                    â†“
```

---

### æµç¨‹åˆ†æ”¯ #1: ç‚¹èµè§†é¢‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šLikeVideoCmd âŒ                                            â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢åˆ° design/aggregate/customer_action/)          â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - videoId: String                                             â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â””â”€ @VideoExists âŒ (éªŒè¯è§†é¢‘å­˜åœ¨)                              â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯ GetVideoInfoQry âœ…                             â”‚
â”‚   2. æŸ¥è¯¢å·²æœ‰ç‚¹èµè®°å½• (å¹‚ç­‰æ€§æ£€æŸ¥)                               â”‚
â”‚   3. Toggle é€»è¾‘:                                               â”‚
â”‚      - å·²ç‚¹èµ â†’ åˆ é™¤è®°å½• (å–æ¶ˆç‚¹èµ)                              â”‚
â”‚      - æœªç‚¹èµ â†’ åˆ›å»ºè®°å½• (æ–°å¢ç‚¹èµ)                              â”‚
â”‚   4. CustomerActionFactory.create()                             â”‚
â”‚   5. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCustomerLikedVideoDomainEvent âœ…                       â”‚
â”‚ çŠ¶æ€ï¼šå·²å®šä¹‰ (design/aggregate/customer_action/_gen.json:32)    â”‚
â”‚                                                                 â”‚
â”‚ äº‹ä»¶è½½è·ï¼š                                                       â”‚
â”‚ {                                                               â”‚
â”‚   "customerId": "U001",                                         â”‚
â”‚   "videoId": "V123456789",                                      â”‚
â”‚   "isCancel": false  // true=å–æ¶ˆç‚¹èµ, false=æ–°å¢ç‚¹èµ            â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†å™¨ï¼šCustomerLikedVideoEventHandler âŒ                    â”‚
â”‚ ç›‘å¬äº‹ä»¶ï¼šCustomerLikedVideoDomainEvent                          â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼šUpdateVideoStatisticsCmd                              â”‚
â”‚ å®ç°è·¯å¾„ï¼šadapter/.../events/CustomerLikedVideoEventHandler.kt  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šUpdateVideoStatisticsCmd âŒ                                â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š{ videoId, field: "like_count", changeCount: Â±1 }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šVideoStatisticsUpdatedDomainEvent âŒ                   â”‚
â”‚ äº‹ä»¶è½½è·ï¼š{ videoId, likeCount, collectCount, coinCount }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æµç¨‹åˆ†æ”¯ #2: æ”¶è—è§†é¢‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šCollectVideoCmd âŒ                                         â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢åˆ° design/aggregate/customer_action/)          â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - videoId: String                                             â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â””â”€ @VideoExists âŒ                                            â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯ GetVideoInfoQry âœ…                             â”‚
â”‚   2. æŸ¥è¯¢å·²æœ‰æ”¶è—è®°å½•                                            â”‚
â”‚   3. Toggle é€»è¾‘ (åŒç‚¹èµ)                                       â”‚
â”‚   4. CustomerActionFactory.create()                             â”‚
â”‚   5. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCustomerCollectedVideoDomainEvent âœ…                   â”‚
â”‚ çŠ¶æ€ï¼šå·²å®šä¹‰ (design/aggregate/customer_action/_gen.json:40)    â”‚
â”‚ äº‹ä»¶è½½è·ï¼š{ customerId, videoId, isCancel }                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†å™¨ï¼šCustomerCollectedVideoEventHandler âŒ                â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼šUpdateVideoStatisticsCmd                              â”‚
â”‚ å‚æ•°ï¼š{ videoId, field: "collect_count", changeCount: Â±1 }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šUpdateVideoStatisticsCmd âŒ                                â”‚
â”‚ + é¢å¤–è§¦å‘ï¼šUpdateElasticsearchCmd âŒ (æ›´æ–°ESæ”¶è—æ•°)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šVideoStatisticsUpdatedDomainEvent ï¿½ï¿½                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æµç¨‹åˆ†æ”¯ #3: æŠ•å¸è§†é¢‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šGiveVideoCoinCmd âŒ                                        â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢åˆ° design/aggregate/customer_action/)          â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - videoId: String                                             â”‚
â”‚   - coinCount: Int (èŒƒå›´: 1-2)                                  â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â”œâ”€ @VideoExists âŒ                                            â”‚
â”‚   â”œâ”€ @NotSelfCoin âŒ (UPä¸»ä¸èƒ½ç»™è‡ªå·±æŠ•å¸)                        â”‚
â”‚   â”œâ”€ @SufficientCoinBalance âŒ (ç¡¬å¸ä½™é¢å……è¶³)                    â”‚
â”‚   â”œâ”€ @NotDuplicateCoin âŒ (åŒä¸€è§†é¢‘åªèƒ½æŠ•å¸ä¸€æ¬¡)                 â”‚
â”‚   â””â”€ @Range(1, 2) coinCount âœ…                                  â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯ GetVideoInfoQry âœ…                             â”‚
â”‚   2. æŸ¥è¯¢å·²æœ‰æŠ•å¸è®°å½• (å¹‚ç­‰æ€§æ£€æŸ¥)                               â”‚
â”‚   3. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ:                                               â”‚
â”‚      - videoUserId != currentUserId                             â”‚
â”‚      - æœªæŠ•è¿‡å¸                                                 â”‚
â”‚   4. CustomerActionFactory.create()                             â”‚
â”‚   5. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCustomerCoinGivenDomainEvent âœ…                        â”‚
â”‚ çŠ¶æ€ï¼šå·²å®šä¹‰ (design/aggregate/customer_action/_gen.json:52)    â”‚
â”‚                                                                 â”‚
â”‚ äº‹ä»¶è½½è·ï¼š                                                       â”‚
â”‚ {                                                               â”‚
â”‚   "customerId": "U001",                                         â”‚
â”‚   "videoId": "V123456789",                                      â”‚
â”‚   "videoUserId": "U999",  // UPä¸»ID                             â”‚
â”‚   "coinCount": 2                                                â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†å™¨ #1 âŒ         â”‚          â”‚ äº‹ä»¶å¤„ç†å™¨ #2 âŒ         â”‚
â”‚ ç¡¬å¸è½¬è´¦                 â”‚          â”‚ æ›´æ–°è§†é¢‘ç»Ÿè®¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šTransferCoinCmd âŒ                                         â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢åˆ° design/extra/coin_transfer_gen.json)        â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - fromCustomerId: "U001"                                      â”‚
â”‚   - toCustomerId: "U999"                                        â”‚
â”‚   - amount: 2                                                   â”‚
â”‚   - reason: "VIDEO_COIN"                                        â”‚
â”‚   - relatedVideoId: "V123456789"                                â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢å‘é€æ–¹ CustomerProfile âœ…                               â”‚
â”‚   2. æŸ¥è¯¢æ¥æ”¶æ–¹ CustomerProfile âœ…                               â”‚
â”‚   3. æ‰£é™¤å‘é€æ–¹ç¡¬å¸ (ä¹è§‚é”: currentCoinCount - amount >= 0)    â”‚
â”‚   4. å¢åŠ æ¥æ”¶æ–¹ç¡¬å¸                                              â”‚
â”‚   5. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCoinTransferredDomainEvent âŒ                          â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢)                                              â”‚
â”‚ äº‹ä»¶è½½è·ï¼š{ fromId, toId, amount, reason, relatedVideoId }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šUpdateVideoStatisticsCmd âŒ                                â”‚
â”‚ å‚æ•°ï¼š{ videoId, field: "coin_count", changeCount: +coinCount }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æµç¨‹åˆ†æ”¯ #4: ç‚¹èµ/ç‚¹è¸©è¯„è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šLikeCommentCmd âŒ / DislikeCommentCmd âŒ                   â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢åˆ° design/aggregate/customer_action/)          â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - videoId: String                                             â”‚
â”‚   - commentId: Long                                             â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â”œâ”€ @VideoExists âŒ                                            â”‚
â”‚   â””â”€ @CommentExists âŒ                                          â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯ GetVideoInfoQry âœ…                             â”‚
â”‚   2. æŸ¥è¯¢è¯„è®ºä¿¡æ¯ GetCommentByIdQry âœ…                           â”‚
â”‚   3. æŸ¥è¯¢å·²æœ‰è¡Œä¸º (ç‚¹èµ/ç‚¹è¸©)                                    â”‚
â”‚   4. äº’æ–¥é€»è¾‘:                                                  â”‚
â”‚      - å·²ç‚¹èµ â†’ ç‚¹èµ â†’ å–æ¶ˆç‚¹èµ                                 â”‚
â”‚      - å·²ç‚¹èµ â†’ ç‚¹è¸© â†’ ç§»é™¤ç‚¹èµ + æ–°å¢ç‚¹è¸©                       â”‚
â”‚      - å·²ç‚¹è¸© â†’ ç‚¹èµ â†’ ç§»é™¤ç‚¹è¸© + æ–°å¢ç‚¹èµ                       â”‚
â”‚      - å·²ç‚¹è¸© â†’ ç‚¹è¸© â†’ å–æ¶ˆç‚¹è¸©                                 â”‚
â”‚   5. CustomerActionFactory.create()                             â”‚
â”‚   6. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCustomerLikedCommentDomainEvent âœ…                     â”‚
â”‚ çŠ¶æ€ï¼šå·²å®šä¹‰ (design/aggregate/customer_action/_gen.json:12)    â”‚
â”‚ äº‹ä»¶è½½è·ï¼š{ customerId, videoId, commentId, isCancel,           â”‚
â”‚            hadOpposite }  // hadOpposite=æ˜¯å¦ç§»é™¤äº†ç›¸åæ“ä½œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†å™¨ï¼šCustomerLikedCommentEventHandler âŒ                  â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼šUpdateCommentStatisticsCmd âŒ                          â”‚
â”‚                                                                 â”‚
â”‚ å‚æ•°ï¼š                                                          â”‚
â”‚   - commentId                                                   â”‚
â”‚   - likeCountChange: Â±1                                         â”‚
â”‚   - hateCountChange: Â±1 æˆ– 0 (å¦‚æœç§»é™¤äº†ç›¸åæ“ä½œ)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šUpdateCommentStatisticsCmd âŒ                              â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢, æˆ–å¤ç”¨å·²æœ‰çš„ UpdateLikeCountCmd âœ…)          â”‚
â”‚                                                                 â”‚
â”‚ è¯´æ˜ï¼šå·²æœ‰å‘½ä»¤å¯å¤ç”¨ï¼Œä½†éœ€è¦å¢å¼ºä¸ºåŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ                â”‚
â”‚   - UpdateLikeCountCmd âœ… (åªæ›´æ–°ç‚¹èµæ•°)                         â”‚
â”‚   - UpdateHateCountCmd âœ… (åªæ›´æ–°ç‚¹è¸©æ•°)                         â”‚
â”‚   å»ºè®®ï¼šæ–°å¢ UpdateCommentStatisticsCmd åŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šCommentStatisticsUpdatedDomainEvent âŒ                 â”‚
â”‚ çŠ¶æ€ï¼šç¼ºå¤± (éœ€æ–°å¢, æˆ–å¤ç”¨å·²æœ‰äº‹ä»¶)                              â”‚
â”‚   - CommentLikeCountUpdatedDomainEvent âœ…                       â”‚
â”‚   - CommentHateCountUpdatedDomainEvent âœ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Mermaid å¯è§†åŒ–æµç¨‹å›¾

```mermaid
graph TD
    A[è¯·æ±‚: POST /userAction/doAction<br/>videoId, actionType, actionCount, commentId] --> B{Controller è·¯ç”±åˆ†å‘}

    B -->|actionType=VIDEO_LIKE| C1[å‘½ä»¤: LikeVideoCmd âŒ]
    B -->|actionType=VIDEO_COLLECT| C2[å‘½ä»¤: CollectVideoCmd âŒ]
    B -->|actionType=VIDEO_COIN| C3[å‘½ä»¤: GiveVideoCoinCmd âŒ]
    B -->|actionType=COMMENT_LIKE| C4[å‘½ä»¤: LikeCommentCmd âŒ]
    B -->|actionType=COMMENT_HATE| C5[å‘½ä»¤: DislikeCommentCmd âŒ]

    C1 --> D1[Toggleé€»è¾‘<br/>æŸ¥è¯¢å·²æœ‰ + æ–°å¢/åˆ é™¤]
    C2 --> D2[Toggleé€»è¾‘<br/>æŸ¥è¯¢å·²æœ‰ + æ–°å¢/åˆ é™¤]
    C3 --> D3[ä¸€æ¬¡æ€§é€»è¾‘<br/>æ ¡éªŒ + æ–°å¢]
    C4 --> D4[äº’æ–¥é€»è¾‘<br/>ç§»é™¤ç›¸å + Toggle]
    C5 --> D5[äº’æ–¥é€»è¾‘<br/>ç§»é™¤ç›¸å + Toggle]

    D1 --> E1[äº‹ä»¶: CustomerLikedVideo âœ…]
    D2 --> E2[äº‹ä»¶: CustomerCollectedVideo âœ…]
    D3 --> E3[äº‹ä»¶: CustomerCoinGiven âœ…]
    D4 --> E4[äº‹ä»¶: CustomerLikedComment âœ…]
    D5 --> E5[äº‹ä»¶: CustomerDislikedComment âœ…]

    E1 --> F1[äº‹ä»¶å¤„ç†å™¨ âŒ<br/>â†’ UpdateVideoStatistics]
    E2 --> F2[äº‹ä»¶å¤„ç†å™¨ âŒ<br/>â†’ UpdateVideoStatistics + ES]
    E3 --> F3A[äº‹ä»¶å¤„ç†å™¨ #1 âŒ<br/>â†’ TransferCoin]
    E3 --> F3B[äº‹ä»¶å¤„ç†å™¨ #2 âŒ<br/>â†’ UpdateVideoStatistics]
    E4 --> F4[äº‹ä»¶å¤„ç†å™¨ âŒ<br/>â†’ UpdateCommentStatistics]
    E5 --> F5[äº‹ä»¶å¤„ç†å™¨ âŒ<br/>â†’ UpdateCommentStatistics]

    F1 --> G1[å‘½ä»¤: UpdateVideoStatisticsCmd âŒ]
    F2 --> G2[å‘½ä»¤: UpdateVideoStatisticsCmd âŒ<br/>+ UpdateElasticsearchCmd âŒ]
    F3A --> G3[å‘½ä»¤: TransferCoinCmd âŒ]
    F3B --> G4[å‘½ä»¤: UpdateVideoStatisticsCmd âŒ]
    F4 --> G5[å‘½ä»¤: UpdateCommentStatisticsCmd âŒ]
    F5 --> G6[å‘½ä»¤: UpdateCommentStatisticsCmd âŒ]

    G1 --> H[âœ… æµç¨‹å®Œæˆ]
    G2 --> H
    G3 --> H
    G4 --> H
    G5 --> H
    G6 --> H

    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    style E1 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style E2 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style E3 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style E4 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style E5 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style H fill:#C8E6C9,stroke:#388E3C,stroke-width:3px

    style C1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style C2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style C3 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style C4 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style C5 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F3A fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F3B fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F4 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style F5 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G3 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G4 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G5 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style G6 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
```

**å›¾ä¾‹è¯´æ˜**ï¼š
- ğŸ”µ è“è‰²ï¼šè¯·æ±‚å…¥å£
- ğŸŸ¢ ç»¿è‰²ï¼šå·²å­˜åœ¨çš„è®¾è®¡ï¼ˆâœ… å¯ç›´æ¥ä½¿ç”¨ï¼‰
- ğŸ”´ çº¢è‰²ï¼šç¼ºå¤±çš„è®¾è®¡ï¼ˆâŒ éœ€å®ç°ï¼‰

---

## ğŸ“¦ è®¾è®¡å…ƒç´ æ¸…å•

### âœ… å·²å­˜åœ¨çš„è®¾è®¡

#### é¢†åŸŸäº‹ä»¶ (Domain Events)

| äº‹ä»¶ | æè¿° | è§¦å‘æ—¶æœº | çŠ¶æ€ | ä½ç½® |
|------|------|----------|------|------|
| `CustomerLikedVideoDomainEvent` | ç”¨æˆ·å·²ç‚¹èµè§†é¢‘ | ç‚¹èµ/å–æ¶ˆç‚¹èµè§†é¢‘ | âœ… å·²å®šä¹‰ | `design/aggregate/customer_action/_gen.json:32` |
| `CustomerCollectedVideoDomainEvent` | ç”¨æˆ·å·²æ”¶è—è§†é¢‘ | æ”¶è—/å–æ¶ˆæ”¶è—è§†é¢‘ | âœ… å·²å®šä¹‰ | `design/aggregate/customer_action/_gen.json:40` |
| `CustomerCoinGivenDomainEvent` | ç”¨æˆ·å·²æŠ•å¸è§†é¢‘ | æŠ•å¸æˆåŠŸ | âœ… å·²å®šä¹‰ | `design/aggregate/customer_action/_gen.json:52` |
| `CustomerLikedCommentDomainEvent` | ç”¨æˆ·å·²ç‚¹èµè¯„è®º | ç‚¹èµ/å–æ¶ˆç‚¹èµè¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/customer_action/_gen.json:12` |
| `CustomerDislikedCommentDomainEvent` | ç”¨æˆ·å·²ç‚¹è¸©è¯„è®º | ç‚¹è¸©/å–æ¶ˆç‚¹è¸©è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/customer_action/_gen.json:20` |
| `CommentLikeCountUpdatedDomainEvent` | è¯„è®ºç‚¹èµæ•°å·²æ›´æ–° | è¯„è®ºç‚¹èµæ•°å˜åŒ– | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:82` |
| `CommentHateCountUpdatedDomainEvent` | è¯„è®ºç‚¹è¸©æ•°å·²æ›´æ–° | è¯„è®ºç‚¹è¸©æ•°å˜åŒ– | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:92` |

#### æŸ¥è¯¢ (Queries)

| æŸ¥è¯¢ | æè¿° | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `GetVideoInfoQry` | è·å–è§†é¢‘ä¿¡æ¯ | âœ… å·²å®šä¹‰ | `design/aggregate/video/_gen.json:94` |
| `GetCustomerProfileQry` | è·å–ç”¨æˆ·æ¡£æ¡ˆ | âœ… å·²å®šä¹‰ | `design/aggregate/customer_profile/_gen.json:84` |
| `GetCommentByIdQry` | æ ¹æ®IDè·å–è¯„è®º | âœ… å·²å®šä¹‰ | `design/aggregate/video_comment/_gen.json:119` |

---

### âŒ ç¼ºå¤±çš„è®¾è®¡æ¸…å•

#### éœ€è¦è¡¥å……çš„å‘½ä»¤ï¼ˆæ ¸å¿ƒï¼‰

| åºå· | å‘½ä»¤åç§° | æè¿° | å‚æ•° | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|------|----------|-------|
| 1 | `LikeVideoCmd` | ç‚¹èµè§†é¢‘ï¼ˆtoggleï¼‰ | `videoId` | `design/aggregate/customer_action/` | P0 |
| 2 | `CollectVideoCmd` | æ”¶è—è§†é¢‘ï¼ˆtoggleï¼‰ | `videoId` | `design/aggregate/customer_action/` | P0 |
| 3 | `GiveVideoCoinCmd` | æŠ•å¸è§†é¢‘ï¼ˆä¸€æ¬¡æ€§ï¼‰ | `videoId, coinCount` | `design/aggregate/customer_action/` | P0 |
| 4 | `LikeCommentCmd` | ç‚¹èµè¯„è®ºï¼ˆtoggle + äº’æ–¥ï¼‰ | `videoId, commentId` | `design/aggregate/customer_action/` | P0 |
| 5 | `DislikeCommentCmd` | ç‚¹è¸©è¯„è®ºï¼ˆtoggle + äº’æ–¥ï¼‰ | `videoId, commentId` | `design/aggregate/customer_action/` | P0 |

**è¯´æ˜**ï¼šè¿™ 5 ä¸ªå‘½ä»¤éœ€è¦åœ¨åç»­è¿­ä»£ä¸­æ›´æ–° `design/aggregate/customer_action/_gen.json`ï¼Œæ›¿æ¢ç°æœ‰çš„ `DoActionCmd`ã€‚

---

#### éœ€è¦è¡¥å……çš„å‘½ä»¤ï¼ˆè¾…åŠ©ï¼‰

| åºå· | å‘½ä»¤åç§° | æè¿° | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|----------|-------|
| 6 | `UpdateVideoStatisticsCmd` | æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯ï¼ˆç‚¹èµ/æ”¶è—/æŠ•å¸æ•°ï¼‰ | `design/extra/video_statistics_gen.json` | P0 |
| 7 | `TransferCoinCmd` | ç¡¬å¸è½¬è´¦ï¼ˆæŠ•å¸åœºæ™¯ï¼‰ | `design/extra/coin_transfer_gen.json` | P0 |
| 8 | `UpdateCommentStatisticsCmd` | æ›´æ–°è¯„è®ºç»Ÿè®¡ä¿¡æ¯ï¼ˆç‚¹èµ/ç‚¹è¸©æ•°ï¼‰ | `design/extra/comment_statistics_gen.json` | P0 |
| 9 | `UpdateElasticsearchCmd` | æ›´æ–°ESç´¢å¼•ï¼ˆæ”¶è—æ•°ï¼‰ | `design/extra/elasticsearch_gen.json` | P1 |

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/video_statistics_gen.json`ï¼‰ï¼š
```json
{
  "cmd": [
    {
      "package": "video",
      "name": "UpdateVideoStatistics",
      "desc": "æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯"
    }
  ]
}
```

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/coin_transfer_gen.json`ï¼‰ï¼š
```json
{
  "cmd": [
    {
      "package": "customer_profile",
      "name": "TransferCoin",
      "desc": "ç¡¬å¸è½¬è´¦"
    }
  ]
}
```

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/comment_statistics_gen.json`ï¼‰ï¼š
```json
{
  "cmd": [
    {
      "package": "video_comment",
      "name": "UpdateCommentStatistics",
      "desc": "æ›´æ–°è¯„è®ºç»Ÿè®¡ä¿¡æ¯ï¼ˆåŒæ—¶æ›´æ–°ç‚¹èµå’Œç‚¹è¸©æ•°ï¼‰"
    }
  ]
}
```

---

#### éœ€è¦è¡¥å……çš„é¢†åŸŸäº‹ä»¶

| åºå· | äº‹ä»¶åç§° | æè¿° | è§¦å‘æ—¶æœº | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|----------|----------|-------|
| 1 | `VideoStatisticsUpdatedDomainEvent` | è§†é¢‘ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–° | è§†é¢‘ç‚¹èµ/æ”¶è—/æŠ•å¸æ•°å˜åŒ– | `design/extra/video_statistics_gen.json` | P0 |
| 2 | `CoinTransferredDomainEvent` | ç¡¬å¸å·²è½¬è´¦ | æŠ•å¸è½¬è´¦å®Œæˆ | `design/extra/coin_transfer_gen.json` | P0 |
| 3 | `CommentStatisticsUpdatedDomainEvent` | è¯„è®ºç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–° | è¯„è®ºç‚¹èµ/ç‚¹è¸©æ•°å˜åŒ– | `design/extra/comment_statistics_gen.json` | P1 |

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/video_statistics_gen.json`ï¼‰ï¼š
```json
{
  "de": [
    {
      "package": "video",
      "name": "VideoStatisticsUpdated",
      "desc": "è§†é¢‘ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°",
      "aggregates": ["Video"],
      "entity": "Video",
      "persist": true
    }
  ]
}
```

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/coin_transfer_gen.json`ï¼‰ï¼š
```json
{
  "de": [
    {
      "package": "customer_profile",
      "name": "CoinTransferred",
      "desc": "ç¡¬å¸å·²è½¬è´¦",
      "aggregates": ["CustomerProfile"],
      "entity": "CustomerProfile",
      "persist": true
    }
  ]
}
```

---

#### éœ€è¦è¡¥å……çš„æŸ¥è¯¢

| åºå· | æŸ¥è¯¢åç§° | æè¿° | è¿”å›å€¼ | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|--------|----------|-------|
| 1 | `GetUserActionByVideoQry` | æŸ¥è¯¢ç”¨æˆ·å¯¹è§†é¢‘çš„å·²æœ‰è¡Œä¸º | `{ actionType, actionCount, actionTime }` | `design/extra/user_action_query_gen.json` | P0 |
| 2 | `CheckUserCoinBalanceQry` | æ£€æŸ¥ç”¨æˆ·ç¡¬å¸ä½™é¢æ˜¯å¦å……è¶³ | `{ sufficient: Boolean, current: Int }` | `design/extra/coin_balance_gen.json` | P0 |

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/user_action_query_gen.json`ï¼‰ï¼š
```json
{
  "qry": [
    {
      "package": "customer_action",
      "name": "GetUserActionByVideo",
      "desc": "æŸ¥è¯¢ç”¨æˆ·å¯¹è§†é¢‘çš„å·²æœ‰è¡Œä¸º"
    }
  ]
}
```

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/coin_balance_gen.json`ï¼‰ï¼š
```json
{
  "qry": [
    {
      "package": "customer_profile",
      "name": "CheckUserCoinBalance",
      "desc": "æ£€æŸ¥ç”¨æˆ·ç¡¬å¸ä½™é¢æ˜¯å¦å……è¶³"
    }
  ]
}
```

---

#### éœ€è¦è¡¥å……çš„éªŒè¯å™¨

| åºå· | éªŒè¯å™¨åç§° | æè¿° | ä¾èµ–æŸ¥è¯¢ | å®ç°è·¯å¾„ | ä¼˜å…ˆçº§ |
|-----|-----------|------|----------|----------|-------|
| 1 | `@VideoExists` | éªŒè¯è§†é¢‘å­˜åœ¨ | `GetVideoInfoQry` | `application/.../validater/VideoExists.kt` | P0 |
| 2 | `@CommentExists` | éªŒè¯è¯„è®ºå­˜åœ¨ | `GetCommentByIdQry` | `application/.../validater/CommentExists.kt` | P0 |
| 3 | `@NotSelfCoin` | éªŒè¯UPä¸»ä¸èƒ½ç»™è‡ªå·±æŠ•å¸ | `GetVideoInfoQry` | `application/.../validater/NotSelfCoin.kt` | P0 |
| 4 | `@SufficientCoinBalance` | éªŒè¯ç”¨æˆ·ç¡¬å¸ä½™é¢å……è¶³ | `CheckUserCoinBalanceQry` | `application/.../validater/SufficientCoinBalance.kt` | P0 |
| 5 | `@NotDuplicateCoin` | éªŒè¯åŒä¸€è§†é¢‘åªèƒ½æŠ•å¸ä¸€æ¬¡ | `GetUserActionByVideoQry` | `application/.../validater/NotDuplicateCoin.kt` | P0 |

---

#### éœ€è¦è¡¥å……çš„äº‹ä»¶å¤„ç†å™¨

| åºå· | å¤„ç†å™¨åç§° | ç›‘å¬äº‹ä»¶ | è§¦å‘å‘½ä»¤ | å®ç°è·¯å¾„ | ä¼˜å…ˆçº§ |
|-----|-----------|----------|----------|----------|-------|
| 1 | `CustomerLikedVideoEventHandler` | `CustomerLikedVideoDomainEvent` | `UpdateVideoStatisticsCmd` | `adapter/.../events/` | P0 |
| 2 | `CustomerCollectedVideoEventHandler` | `CustomerCollectedVideoDomainEvent` | `UpdateVideoStatisticsCmd`<br/>`UpdateElasticsearchCmd` | `adapter/.../events/` | P0 |
| 3 | `CustomerCoinGivenEventHandler` | `CustomerCoinGivenDomainEvent` | `TransferCoinCmd`<br/>`UpdateVideoStatisticsCmd` | `adapter/.../events/` | P0 |
| 4 | `CustomerLikedCommentEventHandler` | `CustomerLikedCommentDomainEvent` | `UpdateCommentStatisticsCmd` | `adapter/.../events/` | P0 |
| 5 | `CustomerDislikedCommentEventHandler` | `CustomerDislikedCommentDomainEvent` | `UpdateCommentStatisticsCmd` | `adapter/.../events/` | P0 |

**ä¼˜å…ˆçº§è¯´æ˜**ï¼š
- **P0**ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å®ç°
- **P1**ï¼šé‡è¦åŠŸèƒ½ï¼Œå»ºè®®å®ç°
- **P2**ï¼šå¯é€‰åŠŸèƒ½ï¼Œåç»­æ‰©å±•

---

## ğŸ”‘ å…³é”®ä¸šåŠ¡è§„åˆ™

### 1. ç‚¹èµ/æ”¶è— - Toggle é€»è¾‘
- å·²ç‚¹èµ â†’ å†æ¬¡ç‚¹å‡» â†’ å–æ¶ˆç‚¹èµï¼ˆåˆ é™¤è®°å½•ï¼Œç»Ÿè®¡ -1ï¼‰
- æœªç‚¹èµ â†’ ç‚¹å‡» â†’ ç‚¹èµï¼ˆæ–°å¢è®°å½•ï¼Œç»Ÿè®¡ +1ï¼‰
- **å¹‚ç­‰æ€§**ï¼šæŸ¥è¯¢å·²æœ‰è®°å½• â†’ å­˜åœ¨åˆ™åˆ é™¤ï¼Œä¸å­˜åœ¨åˆ™æ–°å¢

### 2. æŠ•å¸ - ä¸€æ¬¡æ€§é€»è¾‘
- åŒä¸€è§†é¢‘åªèƒ½æŠ•å¸ä¸€æ¬¡ï¼ˆ**å¹‚ç­‰æ€§**ï¼‰
- UPä¸»ä¸èƒ½ç»™è‡ªå·±æŠ•å¸ï¼ˆ**ä¸šåŠ¡è§„åˆ™**ï¼‰
- ç”¨æˆ·ä½™é¢å¿…é¡»å……è¶³ï¼ˆ**å‰ç½®æ ¡éªŒ**ï¼‰
- æŠ•å¸æ•°é‡èŒƒå›´ï¼š1-2 ä¸ªï¼ˆ**å‚æ•°æ ¡éªŒ**ï¼‰
- **ç¡¬å¸è½¬è´¦æµç¨‹**ï¼š
  1. æ‰£é™¤æŠ•å¸è€…ç¡¬å¸ï¼ˆä¹è§‚é”ï¼‰
  2. å¢åŠ UPä¸»ç¡¬å¸
  3. æ›´æ–°è§†é¢‘æŠ•å¸æ•°ç»Ÿè®¡

### 3. è¯„è®ºç‚¹èµ/ç‚¹è¸© - äº’æ–¥é€»è¾‘
- ç‚¹èµå’Œç‚¹è¸©**äº’æ–¥**ï¼ˆåªèƒ½é€‰ä¸€ä¸ªï¼‰
- **äº’æ–¥åˆ‡æ¢é€»è¾‘**ï¼š
  - å·²ç‚¹èµ â†’ ç‚¹è¸© â†’ ç§»é™¤ç‚¹èµï¼ˆlike -1ï¼‰ + æ–°å¢ç‚¹è¸©ï¼ˆhate +1ï¼‰
  - å·²ç‚¹èµ â†’ å†æ¬¡ç‚¹èµ â†’ å–æ¶ˆç‚¹èµï¼ˆlike -1ï¼‰
  - å·²ç‚¹è¸© â†’ ç‚¹èµ â†’ ç§»é™¤ç‚¹è¸©ï¼ˆhate -1ï¼‰ + æ–°å¢ç‚¹èµï¼ˆlike +1ï¼‰
  - å·²ç‚¹è¸© â†’ å†æ¬¡ç‚¹è¸© â†’ å–æ¶ˆç‚¹è¸©ï¼ˆhate -1ï¼‰
- **åŒæ—¶æ›´æ–°ä¸¤ä¸ªç»Ÿè®¡å­—æ®µ**ï¼šlikeCount å’Œ hateCount

### 4. å¹‚ç­‰æ€§ä¿è¯
- **æŸ¥è¯¢å·²æœ‰è¡Œä¸ºè®°å½•**ï¼š`GetUserActionByVideoQry`
- **æ ¹æ®æ˜¯å¦å­˜åœ¨å†³å®šæ“ä½œ**ï¼šæ–°å¢ or åˆ é™¤
- **ä¹è§‚é”ä¿è¯ç¡¬å¸æ‰£å‡å®‰å…¨**ï¼š`WHERE currentCoinCount - amount >= 0`

---

## ğŸ—ï¸ Controller å±‚è·¯ç”±åˆ†å‘ç¤ºä¾‹

```kotlin
@PostMapping("/doAction")
fun doAction(
    @RequestBody @Validated request: DoActionRequest
): Response {
    val customerId = LoginHelper.getUserId()!!

    when (request.actionType) {
        UserActionType.VIDEO_LIKE ->
            Mediator.commands.send(
                LikeVideoCmd.Request(
                    customerId = customerId,
                    videoId = request.videoId
                )
            )

        UserActionType.VIDEO_COLLECT ->
            Mediator.commands.send(
                CollectVideoCmd.Request(
                    customerId = customerId,
                    videoId = request.videoId
                )
            )

        UserActionType.VIDEO_COIN ->
            Mediator.commands.send(
                GiveVideoCoinCmd.Request(
                    customerId = customerId,
                    videoId = request.videoId,
                    coinCount = request.actionCount ?: 1
                )
            )

        UserActionType.COMMENT_LIKE ->
            Mediator.commands.send(
                LikeCommentCmd.Request(
                    customerId = customerId,
                    videoId = request.videoId,
                    commentId = request.commentId!!
                )
            )

        UserActionType.COMMENT_HATE ->
            Mediator.commands.send(
                DislikeCommentCmd.Request(
                    customerId = customerId,
                    videoId = request.videoId,
                    commentId = request.commentId!!
                )
            )
    }

    return Response()
}
```

---

## ğŸ“Œ è®¾è®¡ä¼˜åŠ¿

### **å¤šå‘½ï¿½ï¿½ï¿½æ¨¡å¼çš„ä¼˜åŠ¿**

ç›¸æ¯”å•ä¸€ `DoActionCmd` çš„è®¾è®¡ï¼š

1. **æ„å›¾æ˜ç¡®**ï¼š
   - `LikeVideoCmd` vs `DoActionCmd(actionType=2)`
   - å‘½ä»¤åç§°å³ä¸šåŠ¡å«ä¹‰ï¼Œæ— éœ€æŸ¥æ–‡æ¡£

2. **ç±»å‹å®‰å…¨**ï¼š
   - `GiveVideoCoinCmd(videoId, coinCount)` - æ˜ç¡®éœ€è¦ coinCount
   - `LikeVideoCmd(videoId)` - ä¸éœ€è¦ coinCountï¼Œé¿å…å‚æ•°å†—ä½™

3. **å•ä¸€èŒè´£**ï¼š
   - æ¯ä¸ª CommandHandler åªå¤„ç†ä¸€ç§è¡Œä¸º
   - ä¸šåŠ¡è§„åˆ™ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤å’Œæµ‹è¯•

4. **æ˜“äºæ‰©å±•**ï¼š
   - æ–°å¢è¡Œä¸ºç±»å‹ â†’ æ–°å¢å‘½ä»¤ + Handler
   - ä¸å½±å“å·²æœ‰ä»£ç ï¼Œç¬¦åˆå¼€é—­åŸåˆ™

5. **ç¬¦åˆ DDD**ï¼š
   - å‘½ä»¤å³é¢†ï¿½ï¿½è¯­è¨€ï¼ˆUbiquitous Languageï¼‰
   - ä¸šåŠ¡ä¸“å®¶ä¸€çœ¼èƒ½çœ‹æ‡‚ç³»ç»Ÿåœ¨åšä»€ä¹ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
