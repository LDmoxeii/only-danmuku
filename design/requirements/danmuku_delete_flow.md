# å¼¹å¹•åˆ é™¤æµç¨‹è®¾è®¡æ–‡æ¡£

> åŸºäº easylive-java é¡¹ç›®éœ€æ±‚ï¼ŒæŒ‰ç…§ DDD äº‹ä»¶é©±åŠ¨æ¨¡å¼è®¾è®¡

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ¦‚è¿°

ç®¡ç†å‘˜åˆ é™¤è¿è§„å¼¹å¹•ï¼Œç³»ç»ŸéªŒè¯å¼¹å¹•å­˜åœ¨æ€§ã€æƒé™ï¼ˆç®¡ç†å‘˜å¯åˆ é™¤æ‰€æœ‰ï¼ŒUPä¸»åªèƒ½åˆ é™¤è‡ªå·±è§†é¢‘çš„å¼¹å¹•ï¼‰ï¼Œåˆ é™¤å¼¹å¹•è®°å½•ï¼Œä¸æ›´æ–°è§†é¢‘å¼¹å¹•ç»Ÿè®¡ï¼ˆç®¡ç†åˆ é™¤ä¸å½±å“ç»Ÿè®¡ï¼‰ã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ASCII æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ï¼šPOST /interact/delDanmu                                    â”‚
â”‚ Payload:                                                        â”‚
â”‚ {                                                               â”‚
â”‚   "danmuId": 123456                                             â”‚
â”‚ }                                                               â”‚
â”‚                                                                 â”‚
â”‚ åœºæ™¯ï¼š                                                           â”‚
â”‚   - ç®¡ç†å‘˜åˆ é™¤è¿è§„å¼¹å¹•ï¼ˆç®¡ç†åå°ï¼‰                                â”‚
â”‚   - UPä¸»åˆ é™¤è‡ªå·±è§†é¢‘çš„å¼¹å¹•ï¼ˆç”¨æˆ·ç«¯ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤ï¼šDeleteDanmukuCmd                                           â”‚
â”‚ çŠ¶æ€ï¼šâœ… å·²å®šä¹‰ (design/aggregate/video_danmuku/_gen.json:10)   â”‚
â”‚                                                                 â”‚
â”‚ å‘½ä»¤å‚æ•°ï¼š                                                       â”‚
â”‚   - danmuId: Long                                               â”‚
â”‚   - operatorId: Long? (å¯é€‰ï¼Œç”¨äºUPä¸»æƒé™æ ¡éªŒ)                   â”‚
â”‚                                                                 â”‚
â”‚ éªŒè¯å™¨ï¼š                                                         â”‚
â”‚   â”œâ”€ @DanmukuExists âœ… (éªŒè¯å¼¹å¹•å­˜åœ¨)                            â”‚
â”‚   â””â”€ @DanmukuDeletePermission âœ… (éªŒè¯åˆ é™¤æƒé™)                  â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   1. æŸ¥è¯¢å¼¹å¹•ä¿¡æ¯ GetDanmukuByIdQry âŒ                            â”‚
â”‚      - å¦‚æœä¸å­˜åœ¨ â†’ æŠ›å‡ºå¼‚å¸¸ "å¼¹å¹•ä¸å­˜åœ¨"                         â”‚
â”‚   2. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯ GetVideoInfoQry âœ…                             â”‚
â”‚      - éªŒè¯è§†é¢‘å­˜åœ¨æ€§                                            â”‚
â”‚   3. æƒé™æ ¡éªŒ (å¦‚æœ operatorId ä¸ä¸º null):                       â”‚
â”‚      - æ£€æŸ¥ operatorId == video.userId                          â”‚
â”‚      - å¦‚æœä¸åŒ¹é… â†’ æŠ›å‡ºå¼‚å¸¸ "æ— æƒé™åˆ é™¤è¯¥å¼¹å¹•"                    â”‚
â”‚      - ç®¡ç†å‘˜æ“ä½œæ—¶ operatorId = nullï¼Œè·³è¿‡æƒé™æ ¡éªŒ               â”‚
â”‚   4. VideoDanmuku.markAsDeleted()                               â”‚
â”‚      - è½¯åˆ é™¤ï¼šè®¾ç½® status = DELETED                             â”‚
â”‚      - æˆ–ç¡¬åˆ é™¤ï¼šç›´æ¥ä»æ•°æ®åº“ç§»é™¤                                 â”‚
â”‚   5. Mediator.uow.save()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢†åŸŸäº‹ä»¶ï¼šDanmukuDeletedDomainEvent                              â”‚
â”‚ çŠ¶æ€ï¼šâœ… å·²å®šä¹‰ (design/aggregate/video_danmuku/_gen.json:37)   â”‚
â”‚                                                                 â”‚
â”‚ äº‹ä»¶è½½è·ï¼š                                                       â”‚
â”‚ {                                                               â”‚
â”‚   "danmukuId": 123456,                                          â”‚
â”‚   "videoId": "V123456789",                                      â”‚
â”‚   "deletedBy": "admin" | "uploader",  // åˆ é™¤è€…ç±»å‹              â”‚
â”‚   "operatorId": "U001" | null,        // æ“ä½œè€…ID                â”‚
â”‚   "deleteTime": 1729267200                                      â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶å¤„ç†å™¨ï¼šDanmukuDeletedEventHandler âŒ                        â”‚
â”‚ ç›‘å¬äº‹ä»¶ï¼šDanmukuDeletedDomainEvent                              â”‚
â”‚ è§¦å‘å‘½ä»¤ï¼šæ—  (ç®¡ç†åˆ é™¤ä¸æ›´æ–°ç»Ÿè®¡)                                 â”‚
â”‚ å®ç°è·¯å¾„ï¼šadapter/.../events/DanmukuDeletedEventHandler.kt     â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘ï¼š                                                       â”‚
â”‚   - è®°å½•å®¡è®¡æ—¥å¿— (ç®¡ç†æ“ä½œæ—¥å¿—)                                   â”‚
â”‚   - å¯é€‰ï¼šé€šçŸ¥è§†é¢‘UPä¸» (å¼¹å¹•è¢«ç®¡ç†å‘˜åˆ é™¤)                          â”‚
â”‚   - ä¸æ›´æ–°è§†é¢‘å¼¹å¹•ç»Ÿè®¡ (ä¸ç”¨æˆ·è‡ªç„¶åˆ é™¤ä¸åŒ)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                      âœ… åˆ é™¤æµç¨‹å®Œæˆ
```

---

### Mermaid å¯è§†åŒ–æµç¨‹å›¾

```mermaid
graph TD
    A[è¯·æ±‚: POST /interact/delDanmu<br/>danmuId] --> B[å‘½ä»¤: DeleteDanmukuCmd âœ…]

    B --> B1[éªŒè¯å™¨: @DanmukuExists âŒ<br/>éªŒè¯å¼¹å¹•å­˜åœ¨]
    B --> B2[éªŒè¯å™¨: @DanmukuDeletePermission âŒ<br/>éªŒè¯åˆ é™¤æƒé™]
    B --> B3[æŸ¥è¯¢: GetDanmukuByIdQry âŒ<br/>è·å–å¼¹å¹•ä¿¡æ¯]
    B --> B4[æŸ¥è¯¢: GetVideoInfoQry âœ…<br/>è·å–è§†é¢‘ä¿¡æ¯]

    B4 --> B5{operatorId æ˜¯å¦ä¸º null?}
    B5 -->|null ç®¡ç†å‘˜| B6[è·³è¿‡æƒé™æ ¡éªŒ<br/>ç®¡ç†å‘˜å¯åˆ é™¤æ‰€æœ‰å¼¹å¹•]
    B5 -->|énull UPä¸»| B7[æƒé™æ ¡éªŒ<br/>operatorId == video.userId]

    B6 --> C[VideoDanmuku.markAsDeleted<br/>è½¯åˆ é™¤ æˆ– ç¡¬åˆ é™¤]
    B7 --> C

    C --> D[é¢†åŸŸäº‹ä»¶: DanmukuDeletedDomainEvent âœ…<br/>danmukuId, videoId, deletedBy, operatorId, deleteTime]

    D --> E[äº‹ä»¶å¤„ç†å™¨: DanmukuDeletedEventHandler âŒ<br/>ç›‘å¬: DanmukuDeleted â†’ è®°å½•å®¡è®¡æ—¥å¿—]

    E --> F[âœ… æµç¨‹å®Œæˆ<br/>ä¸æ›´æ–°è§†é¢‘å¼¹å¹•ç»Ÿè®¡]

    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    style B fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style D fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    style F fill:#C8E6C9,stroke:#388E3C,stroke-width:3px

    style B1 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style B2 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style B3 fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    style E fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
```

**å›¾ä¾‹è¯´æ˜**ï¼š
- ğŸ”µ è“è‰²ï¼šè¯·æ±‚å…¥å£
- ğŸŸ¢ ç»¿è‰²ï¼šå·²å­˜åœ¨çš„è®¾è®¡ï¼ˆâœ… å¯ç›´æ¥ä½¿ç”¨ï¼‰
- ğŸ”´ çº¢è‰²ï¼šç¼ºå¤±çš„è®¾è®¡ï¼ˆâŒ éœ€å®ç°ï¼‰

---

## ğŸ“¦ è®¾è®¡å…ƒç´ æ¸…å•

### âœ… å·²å­˜åœ¨çš„è®¾è®¡

#### å‘½ä»¤ (Commands)

| å‘½ä»¤ | æè¿° | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `DeleteDanmukuCmd` | åˆ é™¤å¼¹å¹• | âœ… å·²å®šä¹‰ | `design/aggregate/video_danmuku/_gen.json:10` |
| `BatchDeleteDanmukuCmd` | æ‰¹é‡åˆ é™¤å¼¹å¹• | âœ… å·²å®šä¹‰ | `design/aggregate/video_danmuku/_gen.json:15` |

#### é¢†åŸŸäº‹ä»¶ (Domain Events)

| äº‹ä»¶ | æè¿° | è§¦å‘æ—¶æœº | çŠ¶æ€ | ä½ç½® |
|------|------|----------|------|------|
| `DanmukuDeletedDomainEvent` | å¼¹å¹•å·²åˆ é™¤ | å¼¹å¹•åˆ é™¤å | âœ… å·²å®šä¹‰ | `design/aggregate/video_danmuku/_gen.json:37` |
| `DanmukuBatchDeletedDomainEvent` | å¼¹å¹•å·²æ‰¹é‡åˆ é™¤ | æ‰¹é‡åˆ é™¤å¼¹å¹•å | âœ… å·²å®šä¹‰ | `design/aggregate/video_danmuku/_gen.json:47` |

#### æŸ¥è¯¢ (Queries)

| æŸ¥è¯¢ | æè¿° | çŠ¶æ€ | ä½ç½® |
|------|------|------|------|
| `GetVideoInfoQry` | è·å–è§†é¢‘ä¿¡æ¯ | âœ… å·²å®šä¹‰ | `design/aggregate/video/_gen.json:94` |
| `GetDanmukuListQry` | è·å–å¼¹å¹•åˆ—è¡¨ | âœ… å·²å®šä¹‰ | `design/aggregate/video_danmuku/_gen.json:59` |

---

### âŒ ç¼ºå¤±çš„è®¾è®¡æ¸…å•

#### éœ€è¦è¡¥å……çš„æŸ¥è¯¢

| åºå· | æŸ¥è¯¢åç§° | æè¿° | è¿”å›å€¼ | å»ºè®®ä½ç½® | ä¼˜å…ˆçº§ |
|-----|---------|------|--------|----------|-------|
| 1 | `GetDanmukuByIdQry` | æ ¹æ®IDè·å–å¼¹å¹• | `{ danmukuId, videoId, customerId, content, postTime, fileId }` | `design/extra/danmuku_query_gen.json` | P0 |

> å½“å‰å‘½ä»¤é€šè¿‡ä»“å‚¨ç›´æ¥æ ¡éªŒå¼¹å¹•å­˜åœ¨æ€§ï¼Œè‹¥åç»­éœ€è¦è¯»æ¨¡å‹å¤ç”¨ï¼Œå†è€ƒè™‘è¡¥å……è¯¥æŸ¥è¯¢ã€‚

**JSON å®šä¹‰**ï¼ˆéœ€æ–°å¢åˆ° `design/extra/danmuku_query_gen.json`ï¼‰ï¼š
```json
{
  "qry": [
    {
      "package": "video_danmuku",
      "name": "GetDanmukuById",
      "desc": "æ ¹æ®IDè·å–å¼¹å¹•"
    }
  ]
}
```

#### éœ€è¦è¡¥å……çš„éªŒè¯å™¨

| åºå· | éªŒè¯å™¨åç§°                      | æè¿°              | å®ç°è·¯å¾„                                                                                                          | çŠ¶æ€ |
|----|----------------------------|-----------------|---------------------------------------------------------------------------------------------------------------|----|
| 1  | `@DanmukuExists`           | éªŒè¯å¼¹å¹•å­˜åœ¨          | `only-danmuku-application/src/main/kotlin/edu/only4/danmuku/application/validater/DanmukuExists.kt`           | âœ…  |
| 2  | `@DanmukuDeletePermission` | éªŒè¯åˆ é™¤æƒé™ï¼ˆUPä¸»æˆ–ç®¡ç†å‘˜ï¼‰ | `only-danmuku-application/src/main/kotlin/edu/only4/danmuku/application/validater/DanmukuDeletePermission.kt` | âœ…  |

#### éœ€è¦è¡¥å……çš„äº‹ä»¶å¤„ç†å™¨

| åºå· | å¤„ç†å™¨åç§° | ç›‘å¬äº‹ä»¶ | è§¦å‘å‘½ä»¤ | å®ç°è·¯å¾„ | ä¼˜å…ˆçº§ |
|-----|-----------|----------|----------|----------|-------|
| 1 | `DanmukuDeletedEventHandler` | `DanmukuDeletedDomainEvent` | æ— ï¼ˆä»…è®°å½•æ—¥å¿—ï¼‰ | `adapter/.../events/DanmukuDeletedEventHandler.kt` | P1 |

**ä¼˜å…ˆçº§è¯´æ˜**ï¼š
- **P0**ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å®ç°
- **P1**ï¼šé‡è¦åŠŸèƒ½ï¼Œå»ºè®®å®ç°
- **P2**ï¼šå¯é€‰åŠŸèƒ½ï¼Œåç»­æ‰©å±•

---

## ğŸ”‘ å…³é”®ä¸šåŠ¡è§„åˆ™

### 1. åˆ é™¤æƒé™æ§åˆ¶
- **ç®¡ç†å‘˜åˆ é™¤**ï¼ˆç®¡ç†åå°ï¼‰ï¼š
  - `operatorId = null`
  - å¯åˆ é™¤ä»»ä½•å¼¹å¹•ï¼Œæ— éœ€æƒé™æ ¡éªŒ
  - ç”¨äºå¤„ç†è¿è§„å†…å®¹

- **UPä¸»åˆ é™¤**ï¼ˆç”¨æˆ·ç«¯ï¼‰ï¼š
  - `operatorId = å½“å‰ç”¨æˆ·ID`
  - åªèƒ½åˆ é™¤è‡ªå·±è§†é¢‘çš„å¼¹å¹•
  - æƒé™æ ¡éªŒï¼š`operatorId == video.userId`
  - æ ¡éªŒå¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ "æ— æƒé™åˆ é™¤è¯¥å¼¹å¹•"

### 2. åˆ é™¤ä¸ç»Ÿè®¡çš„å…³ç³»
- **ç®¡ç†åˆ é™¤**ï¼šä¸æ›´æ–°è§†é¢‘å¼¹å¹•ç»Ÿè®¡
  - åŸå› ï¼šè¿è§„å¼¹å¹•åˆ é™¤ä¸åº”å½±å“è§†é¢‘æ•°æ®
  - å®ç°ï¼šäº‹ä»¶å¤„ç†å™¨ä¸è§¦å‘ç»Ÿè®¡æ›´æ–°å‘½ä»¤

- **ç”¨æˆ·åˆ é™¤**ï¼ˆå¦‚æœæœ‰æ­¤åœºæ™¯ï¼‰ï¼šéœ€æ›´æ–°ç»Ÿè®¡
  - å‘é€ `UpdateVideoStatisticsCmd`
  - å¼¹å¹•æ•° -1

**æ³¨æ„**ï¼šæ ¹æ® easylive-java çš„å®ç°ï¼ˆ`VideoDanmuServiceImpl.deleteDanmu:246`ï¼‰ï¼Œå½“å‰åˆ é™¤æ“ä½œ**ä¸æ›´æ–°ç»Ÿè®¡**ï¼Œè¿™æ˜¯åˆç†çš„è®¾è®¡ï¼Œå› ä¸ºï¼š
- ç®¡ç†åˆ é™¤æ˜¯å†…å®¹å®¡æ ¸è¡Œä¸ºï¼Œä¸åº”å½±å“è§†é¢‘çœŸå®æ•°æ®
- ç”¨æˆ·ä¸€èˆ¬ä¸èƒ½åˆ é™¤è‡ªå·±å‘é€çš„å¼¹å¹•ï¼ˆåªæœ‰UPä¸»å’Œç®¡ç†å‘˜å¯åˆ é™¤ï¼‰

### 3. è½¯åˆ é™¤ vs ç¡¬åˆ é™¤
**æ¨èï¼šè½¯åˆ é™¤**
- è®¾ç½® `status = DELETED` æˆ– `isDeleted = true`
- ä¿ç•™æ•°æ®ç”¨äºå®¡è®¡å’Œè¿½æº¯
- æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤è®°å½•

**ç¡¬åˆ é™¤**ï¼ˆeasylive-java å½“å‰å®ç°ï¼‰ï¼š
- ç›´æ¥ä»æ•°æ®åº“ç§»é™¤è®°å½•
- å®ç°ç®€å•ï¼Œä½†æ— æ³•è¿½æº¯
- é€‚ç”¨äºéšç§åˆè§„è¦æ±‚

### 4. å¼¹å¹•å­˜åœ¨æ€§æ ¡éªŒ
- **æŸ¥è¯¢é¡ºåº**ï¼š
  1. æ ¹æ® `danmuId` æŸ¥è¯¢å¼¹å¹• â†’ `GetDanmukuByIdQry`
  2. æ ¹æ® `videoId` æŸ¥è¯¢è§†é¢‘ â†’ `GetVideoInfoQry`
  3. éªŒè¯ä¸¤è€…éƒ½å­˜åœ¨

- **æ ¡éªŒå¤±è´¥**ï¼šæŠ›å‡º `CODE_600` å¼‚å¸¸ï¼ˆæ•°æ®ä¸å­˜åœ¨ï¼‰

### 5. å®¡è®¡æ—¥å¿—
- **è®°å½•å†…å®¹**ï¼š
  - åˆ é™¤æ—¶é—´ï¼š`deleteTime`
  - åˆ é™¤è€…ç±»å‹ï¼š`deletedBy = "admin" | "uploader"`
  - æ“ä½œè€…IDï¼š`operatorId`
  - è¢«åˆ é™¤å¼¹å¹•ä¿¡æ¯ï¼š`danmukuId, videoId, content`

- **ç”¨é€”**ï¼š
  - ç®¡ç†å‘˜æ“ä½œè¿½æº¯
  - çº çº·å¤„ç†è¯æ®
  - æ•°æ®æ¢å¤ä¾æ®

---

## ğŸ“Š Controller å±‚å®ç°ç¤ºä¾‹

### ç®¡ç†åå°åˆ é™¤

```kotlin
@RestController
@RequestMapping("/admin/interact")
class AdminInteractController {

    @PostMapping("/delDanmu")
    fun delDanmu(
        @RequestParam @NotNull danmuId: Int
    ): Response {
        // ç®¡ç†å‘˜åˆ é™¤ï¼šoperatorId = nullï¼Œæ— æƒé™é™åˆ¶
        Mediator.commands.send(
            DeleteDanmukuCmd.Request(
                danmuId = danmuId,
                operatorId = null  // ç®¡ç†å‘˜æ ‡è¯†
            )
        )
        return Response()
    }
}
```

### ç”¨æˆ·ç«¯åˆ é™¤ï¼ˆUPä¸»åˆ é™¤è‡ªå·±è§†é¢‘çš„å¼¹å¹•ï¼‰

```kotlin
@RestController
@RequestMapping("/api/interact")
class UserInteractController {

    @PostMapping("/delDanmu")
    fun delDanmu(
        @RequestParam @NotNull danmuId: Int
    ): Response {
        val currentUserId = LoginHelper.getUserId()!!

        // UPä¸»åˆ é™¤ï¼šéœ€éªŒè¯æƒé™
        Mediator.commands.send(
            DeleteDanmukuCmd.Request(
                danmuId = danmuId,
                operatorId = currentUserId  // å½“å‰ç”¨æˆ·ID
            )
        )
        return Response()
    }
}
```

---

## ğŸ“Œ è®¾è®¡ä¼˜åŠ¿

### **æƒé™åˆ†ç¦»è®¾è®¡**

é€šè¿‡ `operatorId` å‚æ•°åŒºåˆ†ç®¡ç†å‘˜å’ŒUPä¸»åˆ é™¤ï¼š

1. **çµæ´»çš„æƒé™æ§åˆ¶**ï¼š
   - `operatorId = null` â†’ ç®¡ç†å‘˜æ¨¡å¼ï¼ˆæ— é™åˆ¶ï¼‰
   - `operatorId = userId` â†’ UPä¸»æ¨¡å¼ï¼ˆéœ€æ ¡éªŒæƒé™ï¼‰

2. **å•ä¸€å‘½ä»¤å¤šåœºæ™¯**ï¼š
   - ä¸€ä¸ª `DeleteDanmukuCmd` æ”¯æŒä¸¤ç§åˆ é™¤åœºæ™¯
   - é¿å…åˆ›å»º `AdminDeleteDanmukuCmd` å’Œ `UploaderDeleteDanmukuCmd`

3. **å®¡è®¡è¿½æº¯**ï¼š
   - äº‹ä»¶è½½è·ä¸­è®°å½• `deletedBy` å’Œ `operatorId`
   - æ¸…æ™°åŒºåˆ†åˆ é™¤æ¥æº

4. **ç¬¦åˆ DDD**ï¼š
   - æƒé™æ ¡éªŒé€šè¿‡éªŒè¯å™¨å®ç°ï¼ˆ`@DanmukuDeletePermission`ï¼‰
   - ä¸šåŠ¡è§„åˆ™å°è£…åœ¨èšåˆæ–¹æ³•ä¸­ï¼ˆ`markAsDeleted()`ï¼‰

---

## ğŸ”„ å¯¹æ¯”ï¼šç”¨æˆ·åˆ é™¤å¼¹å¹• vs ç®¡ç†åˆ é™¤å¼¹å¹•

| ç‰¹æ€§ | ç”¨æˆ·åˆ é™¤ï¼ˆå¦‚æœæ”¯æŒï¼‰ | ç®¡ç†åˆ é™¤ï¼ˆå½“å‰éœ€æ±‚ï¼‰ |
|------|---------------------|---------------------|
| **æƒé™** | åªèƒ½åˆ é™¤è‡ªå·±å‘é€çš„å¼¹å¹• | å¯åˆ é™¤ä»»ä½•å¼¹å¹• |
| **ç»Ÿè®¡æ›´æ–°** | éœ€è¦æ›´æ–°è§†é¢‘å¼¹å¹•æ•° -1 | ä¸æ›´æ–°ç»Ÿè®¡ |
| **äº‹ä»¶å¤„ç†** | è§¦å‘ `UpdateVideoStatisticsCmd` | ä»…è®°å½•å®¡è®¡æ—¥å¿— |
| **åœºæ™¯** | ç”¨æˆ·æ’¤å›/ç¼–è¾‘å¼¹å¹• | è¿è§„å†…å®¹å¤„ç† |
| **operatorId** | `customerId`ï¼ˆå‘é€è€…ï¼‰ | `null`ï¼ˆç®¡ç†å‘˜ï¼‰æˆ– `userId`ï¼ˆUPä¸»ï¼‰ |

**å½“å‰éœ€æ±‚**ï¼šç®¡ç†åˆ é™¤å¼¹å¹•ï¼ˆç®¡ç†åå° + UPä¸»ç«¯ï¼‰

---

## ğŸ§© æ‰©å±•è®¾è®¡ï¼šæ‰¹é‡åˆ é™¤å¼¹å¹•

å¦‚æœéœ€è¦æ‰¹é‡åˆ é™¤è¿è§„å¼¹å¹•ï¼ˆä¾‹å¦‚åˆ é™¤æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰å¼¹å¹•ï¼‰ï¼Œå¯ä½¿ç”¨å·²å®šä¹‰çš„ `BatchDeleteDanmukuCmd`ï¼š

```kotlin
@PostMapping("/batchDelDanmu")
fun batchDelDanmu(
    @RequestParam customerId: String?,
    @RequestParam videoId: String?
): Response {
    Mediator.commands.send(
        BatchDeleteDanmukuCmd.Request(
            customerId = customerId,  // åˆ é™¤æŸç”¨æˆ·çš„æ‰€æœ‰å¼¹å¹•
            videoId = videoId,        // åˆ é™¤æŸè§†é¢‘çš„æ‰€æœ‰å¼¹å¹•
            operatorId = null         // ç®¡ç†å‘˜æ“ä½œ
        )
    )
    return Response()
}
```

**æ‰¹é‡åˆ é™¤äº‹ä»¶**ï¼š
- è§¦å‘ `DanmukuBatchDeletedDomainEvent`
- äº‹ä»¶å¤„ç†å™¨ï¼šè®°å½•æ‰¹é‡æ“ä½œæ—¥å¿—ï¼Œå¯é€‰é€šçŸ¥ç”¨æˆ·

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**è¿‘æœŸå˜æ›´**ï¼šè¡¥å…… @DanmukuExistsã€@DanmukuDeletePermission æ ¡éªŒå™¨å¹¶åŒæ­¥å‘½ä»¤å‚æ•°è¯´æ˜ã€‚
