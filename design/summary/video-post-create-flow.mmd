sequenceDiagram
  autonumber
  actor FE as Frontend
  participant Ctrl as CompatibleUCenterVideoPostController
  participant CreatePost as CreateVideoPostCmd
  participant VideoPost as VideoPost
  participant TranscodeReqSub as VideoPostTranscodingRequestedDomainEventSubscriber
  participant StartProcessing as StartVideoPostProcessingCmd
  participant Processing as VideoPostProcessing
  participant ProcessingStartedSub as VideoPostProcessingStartedDomainEventSubscriber
  participant TempQry as GetUploadSessionTempPathQry
  participant MergeCli as MergeUploadToMp4ByPathCli
  participant TranscodeCli as TranscodeVideoFileToAbrByPathCli
  participant UploadCli as UploadVideoAbrOutputCli
  participant GenMasterCli as GenerateVideoAbrMasterCli
  participant ApplyTranscode as ApplyVideoPostProcessingTranscodeResultCmd
  participant TranscodeDoneSub as VideoPostProcessingTranscodeCompletedDomainEventSubscriber
  participant PrepareEncryptCtx as PrepareVideoPostProcessingEncryptContextCmd
  participant EncryptCtxPreparedSub as VideoPostProcessingEncryptContextPreparedDomainEventSubscriber
  participant GenKeyCmd as GenerateVideoPostQualityKeyCmd
  participant KeyAgg as VideoHlsEncryptKey
  participant KeyCreatedSub as VideoPostQualityKeyGeneratedDomainEventSubscriber
  participant EncryptVariantCli as EncryptHlsVariantWithKeyCli
  participant ApplyVariantEncrypt as ApplyVideoPostProcessingVariantEncryptResultCmd
  participant FileEncryptCompletedSub as VideoPostProcessingFileEncryptCompletedDomainEventSubscriber
  participant GenEncMasterCli as GenerateEncryptedMasterByVariantsCli
  participant ApplyEncrypt as ApplyVideoPostProcessingEncryptResultCmd
  participant ProcessingCompletedSub as VideoPostProcessingCompletedDomainEventSubscriber
  participant SyncPost as SyncVideoPostProcessStatusCmd

  FE->>Ctrl: POST /ucenter/createVideo (uploadFileList)
  Ctrl->>CreatePost: CreateVideoPostCmd.Request(...)
  CreatePost->>VideoPost: create + append VideoFilePost[]
  Note over VideoPost: markTranscoding(fileList)
  VideoPost-->>CreatePost: VideoPostTranscodingRequestedDomainEvent
  CreatePost->>CreatePost: UoW save
  CreatePost-->>Ctrl: videoId
  Ctrl-->>FE: response

  VideoPost-->>TranscodeReqSub: VideoPostTranscodingRequestedDomainEvent
  TranscodeReqSub->>StartProcessing: StartVideoPostProcessingCmd(fileList)
  StartProcessing->>Processing: create/find + appendFiles
  Processing-->>StartProcessing: VideoPostProcessingStartedDomainEvent
  StartProcessing->>StartProcessing: UoW save

  Processing-->>ProcessingStartedSub: VideoPostProcessingStartedDomainEvent
  loop each upload file
    ProcessingStartedSub->>TempQry: GetUploadSessionTempPathQry(uploadId)
    TempQry-->>ProcessingStartedSub: tempPath
    ProcessingStartedSub->>MergeCli: MergeUploadToMp4ByPathCli(tempPath, outputDir)
    MergeCli-->>ProcessingStartedSub: mergedMp4Path, duration, fileSize
    ProcessingStartedSub->>TranscodeCli: TranscodeVideoFileToAbrByPathCli(sourcePath, profiles)
    TranscodeCli-->>ProcessingStartedSub: accepted, variantsJson
    ProcessingStartedSub->>UploadCli: UploadVideoAbrOutputCli(outputDir, objectPrefix)
    UploadCli-->>ProcessingStartedSub: success, storagePrefix
    alt upload success
      ProcessingStartedSub->>GenMasterCli: GenerateVideoAbrMasterCli(outputPrefix, variantsJson)
      GenMasterCli-->>ProcessingStartedSub: success, masterPath
    end
    alt transcode/upload/master success
      ProcessingStartedSub->>ApplyTranscode: ApplyVideoPostProcessingTranscodeResultCmd(success=true,...)
    else failure
      ProcessingStartedSub->>ApplyTranscode: ApplyVideoPostProcessingTranscodeResultCmd(success=false,...)
    end

    ApplyTranscode->>Processing: applyTranscodeResult(...)
    Processing-->>TranscodeDoneSub: VideoPostProcessingTranscodeCompletedDomainEvent
    TranscodeDoneSub->>PrepareEncryptCtx: PrepareVideoPostProcessingEncryptContextCmd
    PrepareEncryptCtx->>Processing: prepareEncryptContext(...)
    Processing-->>EncryptCtxPreparedSub: VideoPostProcessingEncryptContextPreparedDomainEvent

    alt context ok and qualities not empty
      loop each quality
        EncryptCtxPreparedSub->>GenKeyCmd: GenerateVideoPostQualityKeyCmd(quality, keyVersion)
        GenKeyCmd->>KeyAgg: create VideoHlsEncryptKey
        KeyAgg-->>KeyCreatedSub: VideoHlsEncryptKeyCreatedDomainEvent
        KeyCreatedSub->>EncryptVariantCli: EncryptHlsVariantWithKeyCli(sourceDir, outputDir, quality, key)
        EncryptVariantCli-->>KeyCreatedSub: success, playlistPath
        KeyCreatedSub->>ApplyVariantEncrypt: ApplyVideoPostProcessingVariantEncryptResultCmd(...)
        ApplyVariantEncrypt->>Processing: applyVariantEncryptResult(...)
      end
    else context missing
      EncryptCtxPreparedSub->>ApplyEncrypt: ApplyVideoPostProcessingEncryptResultCmd(success=false,...)
    end

    Processing-->>FileEncryptCompletedSub: VideoPostProcessingFileEncryptCompletedDomainEvent
    FileEncryptCompletedSub->>GenEncMasterCli: GenerateEncryptedMasterByVariantsCli(outputDir, variantsJson)
    GenEncMasterCli-->>FileEncryptCompletedSub: success, masterPath
    FileEncryptCompletedSub->>ApplyEncrypt: ApplyVideoPostProcessingEncryptResultCmd(...)
    ApplyEncrypt->>Processing: applyEncryptResult(...)
  end

  Processing-->>ProcessingCompletedSub: VideoPostProcessingCompletedDomainEvent
  ProcessingCompletedSub->>SyncPost: SyncVideoPostProcessStatusCmd(...)
