sequenceDiagram
  autonumber
  actor FE as Frontend
  participant C as CompatibleFileController
  participant Cmd as CreateUploadSessionCmd
  participant Sess as VideoFileUploadSession
  participant Sub as UploadSessionCreatedDomainEventSubscriber
  participant TempCli as CreateUploadSessionTempDirCli
  participant InitCmd as InitTempAndStartUploadingCmd
  participant Qry as GetUploadSessionTempPathQry
  participant Storage as UploadVideoChunkStorageCli
  participant UCmd as UploadVideoChunkCmd

  FE->>C: POST /file/preUploadVideo(fileName, chunks)
  C->>Cmd: CreateUploadSessionCmd.Request(customerId, fileName, chunks)
  Cmd->>Sess: create via factory (status=CREATED, expiresAt=now+24h)
  Cmd->>Cmd: UoW save
  Sess-->>Sub: UploadSessionCreatedDomainEvent
  Sub->>TempCli: CreateUploadSessionTempDirCli.Request(uploadId)
  TempCli-->>Sub: tempPath
  Sub->>InitCmd: InitTempAndStartUploadingCmd.Request(uploadId, tempPath)
  InitCmd->>Sess: initTempAndStartUploading (status=UPLOADING, tempPath set)
  InitCmd->>InitCmd: UoW save
  Cmd-->>C: uploadId
  C-->>FE: uploadId

  loop each chunk
    FE->>C: POST /file/uploadVideo(chunkFile, chunkIndex, uploadId)
    C->>Qry: GetUploadSessionTempPathQry(uploadId)
    Qry-->>C: tempPath
    C->>Storage: UploadVideoChunkStorageCli(tempPath, chunkIndex, chunkFile)
    Storage-->>C: storedPath, size
    C->>UCmd: UploadVideoChunkCmd(customerId, uploadId, chunkIndex, size)
    UCmd->>Sess: ensureOwnedBy / ensureActive / ensureChunkAllowed
    UCmd->>Sess: onChunkUploaded (status=UPLOADING, update index/size)
    alt last chunk
      UCmd->>Sess: tryMarkDoneIfComplete (status=DONE)
    end
    UCmd->>UCmd: UoW save
    C-->>FE: success
  end
