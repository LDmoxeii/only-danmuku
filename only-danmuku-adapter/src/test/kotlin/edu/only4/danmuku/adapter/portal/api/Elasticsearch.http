@esHost = https://127.0.0.1:9200
@esUser = elastic
@esPass = 5=7sUQTGcRf_3FVN=aPz

### Cluster info
// @no-verify
GET {{esHost}}/
Authorization: Basic {{esUser}} {{esPass}}

### List indices
// @no-verify
GET {{esHost}}/_cat/indices?v
Authorization: Basic {{esUser}} {{esPass}}

### List plugins
// @no-verify
GET {{esHost}}/_cat/plugins?v
Authorization: Basic {{esUser}} {{esPass}}

### Check target index mapping
// @no-verify
GET {{esHost}}/only-danmuku-video/_mapping
Authorization: Basic {{esUser}} {{esPass}}

### Search latest docs
// @no-verify
GET {{esHost}}/only-danmuku-video/_search?size=10&sort=createTime:desc
Authorization: Basic {{esUser}} {{esPass}}

### Keyword search (update the keyword)
// @no-verify
POST {{esHost}}/only-danmuku-video/_search
Content-Type: application/json
Authorization: Basic {{esUser}} {{esPass}}

{
  "query": {
    "multi_match": {
      "query": "test",
      "fields": [
        "videoName",
        "tags",
        "introduction",
        "categoryFullName",
        "nickName"
      ]
    }
  }
}

### Create index with ik_max_word analyzer (v2)
// @no-verify
PUT {{esHost}}/only-danmuku-video-v2
Content-Type: application/json
Authorization: Basic {{esUser}} {{esPass}}

{
  "settings": {
    "index": {
      "max_ngram_diff": 6
    },
    "analysis": {
      "tokenizer": {
        "ngram_tokenizer": {
          "type": "ngram",
          "min_gram": 2,
          "max_gram": 8,
          "token_chars": [ "letter", "digit" ]
        }
      },
      "analyzer": {
        "ik_max_word_analyzer": {
          "type": "custom",
          "tokenizer": "ik_max_word"
        },
        "ngram_analyzer": {
          "type": "custom",
          "tokenizer": "ngram_tokenizer",
          "filter": [ "lowercase" ]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "videoName": {
        "type": "text",
        "analyzer": "ik_max_word_analyzer",
        "fields": {
          "ngram": { "type": "text", "analyzer": "ngram_analyzer" },
          "keyword": { "type": "keyword", "ignore_above": 256 }
        }
      },
      "tags": {
        "type": "text",
        "analyzer": "ik_max_word_analyzer",
        "fields": {
          "ngram": { "type": "text", "analyzer": "ngram_analyzer" },
          "keyword": { "type": "keyword", "ignore_above": 256 }
        }
      },
      "introduction":     { "type": "text", "analyzer": "ik_max_word_analyzer" },
      "categoryFullName": { "type": "text", "analyzer": "ik_max_word_analyzer" },
      "nickName":         { "type": "text", "analyzer": "ik_max_word_analyzer" }
    }
  }
}

### Reindex from old index into v2
// @no-verify
POST {{esHost}}/_reindex
Content-Type: application/json
Authorization: Basic {{esUser}} {{esPass}}

{
  "source": { "index": "only-danmuku-video" },
  "dest":   { "index": "only-danmuku-video-v2" }
}

### Switch alias to new index (optional)
// @no-verify
POST {{esHost}}/_aliases
Content-Type: application/json
Authorization: Basic {{esUser}} {{esPass}}

{
  "actions": [
    { "remove": { "index": "only-danmuku-video", "alias": "only-danmuku-video" } },
    { "add":    { "index": "only-danmuku-video-v2", "alias": "only-danmuku-video" } }
  ]
}

### Add alias after deleting old index (optional)
// @no-verify
POST {{esHost}}/_aliases
Content-Type: application/json
Authorization: Basic {{esUser}} {{esPass}}

{
  "actions": [
    { "add": { "index": "only-danmuku-video-v2", "alias": "only-danmuku-video" } }
  ]
}

### Verify alias
// @no-verify
GET {{esHost}}/_alias/only-danmuku-video
Authorization: Basic {{esUser}} {{esPass}}

### Delete old index (optional)
// @no-verify
DELETE {{esHost}}/only-danmuku-video
Authorization: Basic {{esUser}} {{esPass}}
