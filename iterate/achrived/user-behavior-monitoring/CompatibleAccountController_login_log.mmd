flowchart TB

    %% 命令触发入口
    N1["CompatibleAccountController.login"]
    class N1 controllermethod;

    %% 登录成功日志
    C1["RecordLoginLogCmd (SUCCESS)"]
    class C1 command;

    %% 密码校验失败领域事件链路
    A1["User.verifyPassword"]
    class A1 entitymethod;

    E1["PasswordInputFailedDomainEvent"]
    class E1 domainevent;

    S1["PasswordInputFailedDomainEventSubscriber"]
    class S1 domaineventhandler;

    C2["RecordLoginLogCmd (FAILURE)"]
    class C2 command;

    Q1["GetRecentPasswordFailureCountQry"]
    class Q1 query;

    C3["RecordAbnormalOperationCmd (PASSWORD_FAIL_TOO_MANY_TIMES)"]
    class C3 command;

    %% Relationships
    N1 -->|登录成功后| C1

    %% 密码错误路径：命令入口 -> 聚合方法 -> 事件 -> 订阅者 -> 查询/命令
    N1 -->|密码登录校验| A1
    A1 -->|密码错误时发布| E1

    E1 -->|on| S1
    S1 -->|记录失败登录日志| C2
    S1 -->|查询最近失败次数| Q1
    Q1 -->|失败次数达到5次| C3

    %% Styles
    classDef controller fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,font-weight:bold;
    classDef controllermethod fill:#e3f2fd,stroke:#1976d2,stroke-width:2px;
    classDef endpoint fill:#e3f2fd,stroke:#42a5f5,stroke-width:2px;
    classDef commandsender fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,font-style:italic;
    classDef commandsendermethod fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,font-style:italic;
    classDef command fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,font-weight:bold;
    classDef commandhandler fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,font-weight:bold;
    classDef aggregate fill:#fff8e1,stroke:#ff8f00,stroke-width:3px,font-weight:bold;
    classDef entitymethod fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef domainevent fill:#fff3e0,stroke:#e65100,stroke-width:2px,font-style:italic;
    classDef domaineventhandler fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,font-weight:bold;
    classDef integrationevent fill:#fce4ec,stroke:#880e4f,stroke-width:2px;
    classDef integrationeventhandler fill:#fce4ec,stroke:#ad1457,stroke-width:2px,font-weight:bold;
    classDef integrationeventconverter fill:#e3f2fd,stroke:#0277bd,stroke-width:2px;
    classDef repo fill:#d6dbdf,stroke:#85929e,stroke-width:2px;
    classDef uow fill:#f2f4f4,stroke:#7f8c8d,stroke-width:2px;
