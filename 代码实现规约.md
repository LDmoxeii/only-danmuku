# 代码实现规约（only-danmuku）

结合《技术特点与原则.md》与现有代码实践，形成如下编写规范，供后续迭代参考。
---

## 1. API 编写原则

- **位置与命名**：所有对外 API 统一放在 `only-danmuku-adapter/src/main/kotlin/edu/only4/danmuku/adapter/portal/api`
  ，按业务拆分控制器文件。
- **请求方式**：对外接口统一使用 `POST`，即便查询也通过 body 收参，保持网关层一致性。
- **职责单一**：Controller 仅负责参数校验、上下文获取与命令/查询调用，不编写业务分支或聚合操作。
- **入参封装**：使用 `Request` DTO 配合 JSR-303 注解和自定义校验器，避免直接暴露领域对象。
- **CQRS 落地**：写操作转为命令（Command），读操作调用查询（Query），禁止控制器内混用命令/查询逻辑。

---

## 2. 命令（Command）编写原则

- **目录规范**：命令位于 `only-danmuku-application/src/main/kotlin/.../commands`，按 Bounded Context 归类。
- **单聚合修改**：单个命令保障只修改一个聚合根，如需影响其他聚合通过领域事件或额外命令完成。
- **标准流程**：`查询聚合 → 调用聚合方法 → 触发领域事件（如有） → Mediator.uow.save()`，保持副作用集中在聚合内。
- **输入输出**：统一使用 `Request`/`Response` 数据类；验证失败抛 `KnownException`。
- **幂等考虑**：命令内应校验当前状态，避免在非法状态重复执行导致脏数据。

---

## 3. 聚合与领域方法

- **行为封装**：状态变更通过聚合方法实现，例如 `markPendingReview`、`markTransferSuccess`，禁止在应用层直接改字段。
- **事件触发**：领域事件由聚合方法内部通过 `events().attach(this) { ... }` 触发，确保事件语义与聚合状态变更一致。
- **跨聚合通信**：禁止直接依赖其他聚合实例，协作依赖领域事件或应用层命令。
- **初始化逻辑**：新增实体需提供 `onCreate()` 或工厂方法，统一设置默认状态并触发必要事件。

---

## 4. 领域事件编写原则

- **命名规范**：采用“实体 + 动作”命名，如 `VideoDraftCreatedDomainEvent`，并默认 `persist = true` 以支持追溯。
- **发布位置**：事件在聚合方法内部发布，或者在工厂方法/`onCreate`里一次性初始化。
- **事件内容**：事件主体传递聚合实体（或必要的只读快照），避免在监听器中再次查库。

---

## 5. 事件监听原则

- **位置**：监听器位于 `only-danmuku-application/src/main/kotlin/.../subscribers/domain`，按领域划分。
- **职责**：监听器只做流程编排，如触发命令、联动外部服务，不直接操作数据库字段。
- **事务收尾**：监听完成后视情况 `Mediator.uow.save()`，保持事件链中的状态一致。
- **异常处理**：监听器需捕获执行异常，记录日志或补偿，避免吞掉异常导致事件中断。
- **幂等**：若监听可能重复触发，内部通过状态/标记确保再次执行不会产生副作用。

---

## 6. 查询（Query）编写原则

- **位置**：查询位于 `only-danmuku-application/src/main/kotlin/.../queries`。
- **数据模型**：返回 DTO 或 `queries._share.model` 中的投影对象，禁止返回聚合实体。
- **只读约束**：查询不应修改任何聚合或外部状态，必要数据可在查询层做格式化。
- **分页排序**：统一在查询层完成分页、排序逻辑，避免在控制层拼接 SQL 条件。

---

## 7. 校验器编写原则

- **自定义注解**：校验注解放在 `application.validater` 包下，命名以业务语义命名，如 `@MaxVideoPCount`。
- **实现方式**：使用 `ConstraintValidator`，必要时通过 `Mediator` 查询上下文，避免在命令执行后才发现参数非法。
- **异常输出**：校验失败抛 `KnownException` 或构造 `ConstraintViolation`，提示文案需友好、明确。
- **复用**：常见校验（权限、状态、数量等）提取为通用校验器，供多命令复用。

---

## 8. 其他通用约定

- **CQRS 严格划分**：命令与查询代码互不引用，避免在命令中进行读模型映射。
- **异常统一**：业务异常使用 `KnownException`，系统异常让上层兜底。
- **日志**：仅在关键步骤写日志（如转码开始/结束、失败原因），日志信息包含关键标识（videoId、uploadId 等）。
- **配置与常量**：涉及路径、阈值引用 `VideoAppProperties` / `SysSettingProperties` 等配置类，不在代码中硬编码。

---
以上约定覆盖 API、命令、聚合、事件、查询、校验器等常见研发场景，可根据业务扩展。执行时若有偏差，需在 code review
中提醒并校正。*** End Patch
