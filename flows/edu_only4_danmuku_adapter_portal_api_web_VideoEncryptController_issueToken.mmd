flowchart TD
  N1[[GetVideoFileContextByIdQryHandler]]
  class N1 queryhandler
  N2[[GetLatestVideoHlsKeyVersionQryHandler]]
  class N2 queryhandler
  N3([VideoEncryptController::issueToken])
  class N3 controllermethod
  N4[[UpdateStatisticsInfoCmd.Handler]]
  class N4 commandhandler
  N5{{UpdateStatisticsInfoCmd.Request}}
  class N5 command
  N6[[ApplyVideoPlayCountDeltaCmd.Handler]]
  class N6 commandhandler
  N7{{ApplyVideoPlayCountDeltaCmd.Request}}
  class N7 command
  N8[[IssueVideoHlsKeyTokenCmd.Handler]]
  class N8 commandhandler
  N9{{IssueVideoHlsKeyTokenCmd.Request}}
  class N9 command
  N10[[AddPlayHistoryCmd.Handler]]
  class N10 commandhandler
  N11{{AddPlayHistoryCmd.Request}}
  class N11 command
  N12{{GetVideoFileContextByIdQry.Request}}
  class N12 query
  N13{{GetLatestVideoHlsKeyVersionQry.Request}}
  class N13 query
  N14[[StatisticsCountUpdatedDomainEventSubscriber::on]]
  class N14 domaineventhandler
  N15[[VideoPlayCountDeltaAppliedDomainEventSubscriber::on]]
  class N15 domaineventhandler
  N16[[VideoHlsKeyTokenIssuedDomainEventSubscriber::addPlayHistoryCmd]]
  class N16 domaineventhandler
  N17[[VideoHlsKeyTokenIssuedDomainEventSubscriber::applyVideoPlayCountDelta]]
  class N17 domaineventhandler
  N18[[VideoPlayHistoryCreatedDomainEventSubscriber::on]]
  class N18 domaineventhandler
  N19[[VideoPlayHistoryProgressUpdatedDomainEventSubscriber::on]]
  class N19 domaineventhandler
  N20(Statistics::onCreate)
  class N20 entitymethod
  N21(Statistics::updateCount)
  class N21 entitymethod
  N22((StatisticsCountUpdatedDomainEvent))
  class N22 domainevent
  N23(Video::&lt;get-id&gt;)
  class N23 entitymethod
  N24(Video::&lt;get-playCount&gt;)
  class N24 entitymethod
  N25(Video::applyPlayCountDelta)
  class N25 entitymethod
  N26((VideoPlayCountDeltaAppliedDomainEvent))
  class N26 domainevent
  N27(VideoHlsKeyToken::onCreate)
  class N27 entitymethod
  N28((VideoHlsKeyTokenIssuedDomainEvent))
  class N28 domainevent
  N29(VideoPlayHistory::onCreate)
  class N29 entitymethod
  N30(VideoPlayHistory::updatePlayProgress)
  class N30 entitymethod
  N31((VideoPlayHistoryCreatedDomainEvent))
  class N31 domainevent
  N32((VideoPlayHistoryProgressUpdatedDomainEvent))
  class N32 domainevent
  N3 -->|ControllerMethodToCommand| N9
  N3 -->|ControllerMethodToQuery| N12
  N3 -->|ControllerMethodToQuery| N13
  N4 -->|CommandHandlerToEntityMethod| N20
  N4 -->|CommandHandlerToEntityMethod| N21
  N5 -->|CommandToCommandHandler| N4
  N6 -->|CommandHandlerToEntityMethod| N23
  N6 -->|CommandHandlerToEntityMethod| N24
  N6 -->|CommandHandlerToEntityMethod| N25
  N7 -->|CommandToCommandHandler| N6
  N8 -->|CommandHandlerToEntityMethod| N27
  N9 -->|CommandToCommandHandler| N8
  N10 -->|CommandHandlerToEntityMethod| N29
  N10 -->|CommandHandlerToEntityMethod| N30
  N11 -->|CommandToCommandHandler| N10
  N12 -->|QueryToQueryHandler| N1
  N13 -->|QueryToQueryHandler| N2
  N15 -->|DomainEventHandlerToCommand| N5
  N16 -->|DomainEventHandlerToCommand| N11
  N17 -->|DomainEventHandlerToCommand| N7
  N21 -->|EntityMethodToDomainEvent| N22
  N22 -->|DomainEventToHandler| N14
  N25 -->|EntityMethodToDomainEvent| N26
  N26 -->|DomainEventToHandler| N15
  N27 -->|EntityMethodToDomainEvent| N28
  N28 -->|DomainEventToHandler| N16
  N28 -->|DomainEventToHandler| N17
  N29 -->|EntityMethodToDomainEvent| N31
  N30 -->|EntityMethodToDomainEvent| N32
  N31 -->|DomainEventToHandler| N18
  N32 -->|DomainEventToHandler| N19
  classDef command fill:#FDBA74,stroke:#C2410C,color:#111827
  classDef commandhandler fill:#F97316,stroke:#9A3412,color:#111827
  classDef controllermethod fill:#FDE68A,stroke:#B45309,color:#111827
  classDef domainevent fill:#FECACA,stroke:#B91C1C,color:#111827
  classDef domaineventhandler fill:#F87171,stroke:#991B1B,color:#111827
  classDef entitymethod fill:#F3F4F6,stroke:#6B7280,color:#111827
  classDef query fill:#93C5FD,stroke:#1D4ED8,color:#0F172A
  classDef queryhandler fill:#3B82F6,stroke:#1E40AF,color:#F8FAFC
